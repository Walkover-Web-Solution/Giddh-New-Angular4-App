<div class="container-fluid">
    <div class="top-bar aging-top-bar d-flex justify-content-between">
        <div class="aging-form-inline">
            <div class="btn-group pull-left on-desktop-view">
                <button mat-raised-button class="btn-sky-blue" (click)="creteNewCustomerEvent.emit(true)">
                    {{ localeData?.new_customer }}
                </button>
            </div>
            <div
                class="form-group mr-r15 pull-left linked-entities mb-0"
                *ngIf="currentCompanyBranches?.length > 2 && currentOrganizationType === 'COMPANY'"
            >
                <div class="form-group mb-0">
                    <sh-select
                        [options]="currentCompanyBranches"
                        [(ngModel)]="currentBranch.uniqueName"
                        [showClear]="false"
                        [ItemHeight]="33"
                        width="100%"
                        (selected)="handleBranchChange($event)"
                        [isFilterEnabled]="true"
                        [placeholder]="commonLocaleData?.app_select_entity"
                        [fixedValue]="currentBranch?.alias"
                    >
                        <ng-template #optionTemplate let-option="option">
                            <ng-container>
                                <a href="javascript:void(0)" class="list-item d-flex">
                                    <span class="entity-icon">
                                        <i
                                            class="icon-branch-icon pull-right"
                                            *ngIf="!option.isCompany"
                                            tooltip="{{ commonLocaleData?.app_branch }}"
                                        ></i>
                                        <i
                                            class="icon-company-profile pull-right"
                                            *ngIf="option.isCompany"
                                            tooltip="{{ commonLocaleData?.app_company }}"
                                        ></i>
                                    </span>
                                    <span class="entity-details">
                                        <div class="item giddh-limit single-line-clamp">{{ option?.label || "-" }}</div>
                                        <div class="item-unique giddh-limit single-line-clamp">
                                            {{ option?.name || "-" }}
                                        </div>
                                    </span>
                                </a>
                            </ng-container>
                        </ng-template>
                    </sh-select>
                </div>
            </div>
            <form #invoiceForm="ngForm" novalidate class="form-inline input-grp-date-range-picker position-relative">
                <div class="form-group mr-r15 d-flex flex-fill">
                    <div class="form-group custom-datepicker mr-r15" (click)="showGiddhDatepicker($event)">
                        <i class="icon-calender calendar-addon"></i>
                        <input
                            matInput
                            type="text"
                            name="selectedDateRange"
                            [value]="selectedDateRangeUi ? selectedDateRangeUi : ''"
                            class="giddh-datepicker form-control date-range-picker"
                        />
                    </div>
                </div>
            </form>
        </div>
        <div class="d-flex justify-content-between">
            <div class="pull-left d-flex wrap-searching-aging">
                <div
                    class="form-group search-field max-width-250"
                    [ngClass]="{ 'default-width': isAdvanceSearchApplied }"
                >
                    <text-field
                        type="text"
                        [placeholder]="localeData?.name_amount"
                        [cssClass]="'form-control name-width'"
                        [(ngModel)]="searchStr"
                        (ngModelChange)="searchStr$.next($event)"
                    ></text-field>
                    <span class="input-addon">
                        <i class="icon-search"></i>
                    </span>
                </div>
            </div>
            <div class="cp advance-clear-filter-icons d-flex float-right">
                <button
                    mat-stroked-button
                    color="primary"
                    class="advance-icon"
                    (click)="toggleAdvanceSearchPopup()"
                    matTooltip="{{ commonLocaleData?.app_advance_search }}"
                    matTooltipPosition="right"
                >
                    <div class="d-flex align-items-center">
                        {{ commonLocaleData?.app_filter }}
                        <span class="icon-advance-filter ml-2"></span>
                    </div>
                </button>
                <span class="refresh-btn" *ngIf="isAdvanceSearchApplied">
                    <button mat-icon-button (click)="resetAdvanceSearch()">
                        <i
                            aria-hidden="true"
                            class="icon-refresh"
                            tooltip="{{ commonLocaleData?.app_reset_filter }}"
                        ></i>
                    </button>
                </span>
            </div>
        </div>
        <div class="btn-group mr-t15 pull-left mobile-view">
            <button mat-raised-button class="btn-sky-blue w-100" (click)="creteNewCustomerEvent.emit(true)">
                {{ localeData?.new_customer }}
            </button>
        </div>
    </div>
    <div class="top-content" [hidden]="!(dueAmountReportData$ | async)?.results?.length">
        <div class="d-flex w-100 justify-content-between overflow-x-auto">
            <div class="total-due-sale total-details-box opening-box border-none mr-r05">
                <h5>
                    {{ commonLocaleData?.app_upcoming }}
                    <div>
                        <span class="d-inline-flex number-total">
                            <amount-field
                                [amount]="totalFutureDueAmounts"
                                [currencySymbol]="false"
                                [currencyCode]="false"
                            >
                            </amount-field
                            >/-
                        </span>
                    </div>
                </h5>
            </div>
            <div class="total-due-sale total-details-box due-box border-none">
                <h5>
                    {{ commonLocaleData?.app_due }}
                    <div>
                        <span class="d-inline-flex number-total">
                            <amount-field [amount]="totalDueAmounts" [currencySymbol]="false" [currencyCode]="false">
                            </amount-field
                            >/-
                        </span>
                    </div>
                </h5>
            </div>
        </div>
    </div>
    <div class="contact-main aging-page">
        <div class="pd-b2 mr-b1 mr-t1 on-mobile-view mobile-card-wrapper">
            <div *ngIf="!isMobileScreen" class="table-responsive">
                <ng-container *ngTemplateOutlet="mainTable"></ng-container>
            </div>
            <div *ngIf="isMobileScreen">
                <div class="text-center top-aging-table-top pd-1">
                    <p (click)="openAgingDropDown()">
                        <strong>{{ localeData?.due_in_last_days }} </strong>
                    </p>
                    <aging-dropdown
                        *ngIf="setDueRangeOpen$ | async"
                        [options]="agingDropDownoptions"
                        [localeData]="localeData"
                        [commonLocaleData]="commonLocaleData"
                    ></aging-dropdown>
                </div>
                <ng-container *ngTemplateOutlet="mainTable"></ng-container>
            </div>
            <div
                class="no-data"
                *ngIf="!(dueAmountReportData$ | async)?.results?.length && !(getAgingReportRequestInProcess$ | async)"
            >
                <no-data [secondaryMessageClass]="'p-0'"></no-data>
            </div>
        </div>
    </div>
</div>
<!--region advance_search Modal-->
<ng-template #advanceSearch tabindex="-1">
    <div>
        <app-contact-advance-search-component
            *ngIf="advanceSearch"
            #agingReportAdvanceSearch
            [request]="commonRequest"
            [advanceSearch4]="'agingReport'"
            [localeData]="localeData"
            [commonLocaleData]="commonLocaleData"
            (applyAdvanceSearchEvent)="applyAdvanceSearch($event)"
            (closeModelEvent)="onNoClick()"
        >
        </app-contact-advance-search-component>
    </div>
</ng-template>
<!-- endregion -->
<!-- region sorting template -->
<ng-template #sortingTemplate let-col>
    <div class="icon-pointer cp">
        <div
            class="icon-sort-asc text-light-2 d-block font-xxs"
            (click)="sort(col, 'asc')"
            *ngIf="key !== col"
            [ngClass]="{ 'active-text-color': key === col && order === 'asc' }"
        ></div>
        <div
            class="icon-sort-asc text-light-2 d-block font-xxs"
            (click)="sort(col, 'desc')"
            *ngIf="key === col && order === 'asc'"
            [ngClass]="{ 'active-text-color': key === col && order === 'asc' }"
        ></div>
        <div
            class="icon-sort-asc text-light-2 d-block font-xxs"
            *ngIf="key === col && order === 'desc'"
            (click)="sort(col, 'asc')"
            [ngClass]="{ 'active-text-color': key === col && order === 'desc' }"
        ></div>
    </div>
</ng-template>
<!-- endregion -->
<ng-template #mainTable>
    <div [hidden]="!(dueAmountReportData$ | async)?.results?.length && !dueAmountReportRequest?.q">
        <div class="d-flex justify-content-end">
            <mat-menu #agingDropdown="matMenu" class="aging-dropdown-table">
                <aging-dropdown
                    [options]="agingDropDownoptions"
                    *ngIf="setDueRangeOpen$ | async"
                    [localeData]="localeData"
                    [commonLocaleData]="commonLocaleData"
                ></aging-dropdown>
            </mat-menu>
        </div>

        <table mat-table [dataSource]="agingReportDataSource" class="w-100">
            <ng-container matColumnDef="customerName">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    #searchCustomerContainer
                    (clickOutside)="handleClickOutside($event, searchCustomerContainer, 'name')"
                >
                    <div class="d-flex align-items-center">
                        <ng-container
                            *ngTemplateOutlet="
                                searchTemplate;
                                context: {
                                    $implicit: showNameSearch,
                                    fieldName: 'name',
                                    formControl: searchedName,
                                    title: commonLocaleData?.app_customer_name
                                }
                            "
                        ></ng-container>
                        <ng-container
                            *ngTemplateOutlet="!showNameSearch ? sortingTemplate : ''; context: { $implicit: 'name' }"
                        ></ng-container>
                    </div>
                </th>
                <td mat-cell *matCellDef="let element" [attr.data-title]="commonLocaleData?.app_name">
                    {{ element.name }}
                </td>
            </ng-container>

            <ng-container matColumnDef="parentGroup">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center">
                        {{ commonLocaleData?.app_parent_group }}
                        <ng-container
                            *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'group' }"
                        ></ng-container>
                    </div>
                </th>
                <td mat-cell *matCellDef="let element" [attr.data-title]="localeData?.group_name">
                    {{ element.groupName }}
                </td>
            </ng-container>

            <ng-container matColumnDef="app_upcoming_due">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        {{ commonLocaleData?.app_upcoming_due }}
                        <ng-container *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'futureDueAmount' }">
                        </ng-container>
                    </div>
                </th>
                <td mat-cell *matCellDef="let element" [attr.data-title]="commonLocaleData?.app_due_amount">
                    <span class="d-flex justify-content-end">
                        <amount-field
                            [amount]="element.futureDueAmount"
                            [currencySymbol]="false"
                            [currencyCode]="false"
                        >
                        </amount-field>
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="app_days_1">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        <button
                            mat-button
                            (click)="openAgingDropDown()"
                            [matMenuTriggerFor]="agingDropdown"
                            class="font-italic"
                        >
                            0-{{ (agingDropDownoptions$ | async)?.fourth }} {{ commonLocaleData?.app_days }}
                        </button>

                        <ng-container
                            *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'range0' }"
                        ></ng-container>
                    </div>
                </th>
                <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.data-title]="
                        '0 - ' + (agingDropDownoptions$ | async)?.fourth + ' ' + commonLocaleData?.app_days
                    "
                >
                    <span class="d-flex justify-content-end">
                        <amount-field
                            [amount]="element.currentAndPastDueAmount[0].dueAmount"
                            [currencySymbol]="false"
                            [currencyCode]="false"
                        >
                        </amount-field>
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="app_days_2">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        <button
                            [matMenuTriggerFor]="agingDropdown"
                            mat-button
                            (click)="openAgingDropDown()"
                            class="font-italic m-0"
                        >
                            {{ (agingDropDownoptions$ | async)?.fourth + 1 }}-{{
                                (agingDropDownoptions$ | async)?.fifth
                            }}
                            {{ commonLocaleData?.app_days }}
                        </button>
                        <ng-container *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'range1' }">
                        </ng-container>
                    </div>
                </th>
                <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.data-title]="
                        (agingDropDownoptions$ | async)?.fourth +
                        1 +
                        ' - ' +
                        (agingDropDownoptions$ | async)?.fifth +
                        ' ' +
                        commonLocaleData?.app_days
                    "
                >
                    <span (click)="openAgingDropDown()">
                        <span class="d-flex justify-content-end">
                            <amount-field
                                [amount]="element.currentAndPastDueAmount[1].dueAmount"
                                [currencySymbol]="false"
                                [currencyCode]="false"
                            >
                            </amount-field>
                        </span>
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="app_days_3">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        <button
                            mat-button
                            (click)="openAgingDropDown()"
                            [matMenuTriggerFor]="agingDropdown"
                            class="font-italic m-0"
                        >
                            {{ (agingDropDownoptions$ | async)?.fifth + 1 }}-{{
                                (agingDropDownoptions$ | async)?.sixth
                            }}
                            {{ commonLocaleData?.app_days }}
                        </button>
                        <ng-container *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'range2' }">
                        </ng-container>
                    </div>
                </th>
                <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.data-title]="
                        (agingDropDownoptions$ | async)?.fifth +
                        1 +
                        ' - ' +
                        (agingDropDownoptions$ | async)?.sixth +
                        ' ' +
                        commonLocaleData?.app_days
                    "
                >
                    <span class="d-flex justify-content-end">
                        <amount-field
                            [amount]="element.currentAndPastDueAmount[2].dueAmount"
                            [currencySymbol]="false"
                            [currencyCode]="false"
                        >
                        </amount-field>
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="app_days_4">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        <button
                            mat-button
                            (click)="openAgingDropDown()"
                            [matMenuTriggerFor]="agingDropdown"
                            class="font-italic m-0"
                        >
                            {{ (agingDropDownoptions$ | async)?.sixth + 1 }}+ {{ commonLocaleData?.app_days }}
                        </button>
                        <ng-container *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'range3' }">
                        </ng-container>
                    </div>
                </th>
                <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.data-title]="(agingDropDownoptions$ | async)?.sixth + 1 + ' ' + commonLocaleData?.app_days"
                >
                    <span class="d-flex justify-content-end">
                        <amount-field
                            [amount]="element.currentAndPastDueAmount[3].dueAmount"
                            [currencySymbol]="false"
                            [currencyCode]="false"
                        >
                        </amount-field>
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="app_total_due">
                <th mat-header-cell *matHeaderCellDef>
                    <div class="d-flex align-items-center justify-content-end">
                        {{ commonLocaleData?.app_total_due }}
                        <ng-container *ngTemplateOutlet="sortingTemplate; context: { $implicit: 'totalDueAmount' }">
                        </ng-container>
                    </div>
                </th>
                <td mat-cell *matCellDef="let element" [attr.data-title]="commonLocaleData?.app_total_amount">
                    <span class="d-flex justify-content-end">
                        <amount-field [amount]="element.totalDueAmount" [currencySymbol]="false" [currencyCode]="false">
                        </amount-field>
                    </span>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="agingReportDisplayedColumns; sticky: true"></tr>

            <tr mat-row *matRowDef="let row; columns: agingReportDisplayedColumns"></tr>
        </table>
    </div>

    <div *ngIf="getAgingReportRequestInProcess$ | async">
        <giddh-page-loader [cssClass]="'mt-0 mb-0'"></giddh-page-loader>
    </div>

    <div *ngIf="(dueAmountReportData$ | async)?.totalItems >= 20" class="pagination-wrapper">
        <div class="xs-pl-0">
            <div class="text-center unbold">
                <div id="pagination" element-view-container-ref #paginationChild="elementviewcontainerref"></div>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #datepickerTemplate>
    <div class="datepicker-modal">
        <div class="modal-body">
            <app-datepicker-wrapper
                [inputStartDate]="selectedDateRange?.startDate"
                [inputEndDate]="selectedDateRange?.endDate"
                [alwaysShowCalendars]="true"
                [ranges]="datePickerOptions"
                [selectedRangeLabel]="selectedRangeLabel"
                [showCustomRangeLabel]="true"
                [showClearButton]="false"
                [showCancel]="true"
                [linkedCalendars]="true"
                [showDropdowns]="true"
                (rangeClicked)="selectedDate($event)"
                (datesUpdated)="selectedDate($event)"
                [keepCalendarOpeningWithRange]="false"
                [showRangeLabelOnInput]="false"
                [dateFieldPosition]="dateFieldPosition"
            ></app-datepicker-wrapper>
        </div>
    </div>
</ng-template>
<ng-template
    #searchTemplate
    let-show
    let-title="title"
    let-placeholder="placeholder"
    let-fieldName="fieldName"
    let-formControl="formControl"
>
    <div class="align-items-center d-flex" [hidden]="show">
        <button mat-icon-button (click)="toggleSearch(fieldName, searchBox)">
            <span class="icon-search"></span>
        </button>
        <span>{{ title }}</span>
    </div>
    <div [hidden]="!show">
        <text-field
            type="text"
            [placeholder]="getSearchFieldText(fieldName)"
            [cssClass]="'form-control search-table'"
            #searchBox
            [formControl]="formControl"
        ></text-field>
    </div>
</ng-template>
