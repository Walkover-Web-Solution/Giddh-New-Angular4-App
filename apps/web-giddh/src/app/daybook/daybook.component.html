<hamburger-menu [pageHeading]="'Daybook'"></hamburger-menu>
<giddh-page-loader *ngIf="showLoader"></giddh-page-loader>
<ng-container *ngIf="!showLoader">
<div class="transactions-page pd-t15 position-relative clearfix">

    <!-- ledger header -->
    <div class="col-md-12">
        <div>
            <div class="form-group mr-r15 pull-left linked-entities" *ngIf="currentCompanyBranches?.length > 2 && currentOrganizationType === 'COMPANY'">
                <div class="form-group">
                    <sh-select [options]="currentCompanyBranches" [(ngModel)]="currentBranch.uniqueName" [showClear]="false"
                        [ItemHeight]="33" width="100%" (selected)="handleBranchChange($event)" [isFilterEnabled]="true"
                        placeholder="Select Entity" [fixedValue]="currentBranch?.alias">
                        <ng-template #optionTemplate let-option="option">
                            <ng-container>
                                <a href="javascript:void(0)" class="list-item d-flex">
                                    <span class="entity-icon">
                                        <i class="icon-branch-icon pull-right" *ngIf="!option.isCompany"
                                            tooltip="Branch"></i>
                                        <i class="icon-company-profile pull-right" *ngIf="option.isCompany" tooltip="Company"></i>
                                    </span>
                                    <span class="entity-details">
                                        <div class="item giddh-limit single-line-clamp">{{ option.label || '-' }}</div>
                                        <div class="item-unique giddh-limit single-line-clamp">
                                            {{ option.name || '-' }}
                                        </div>
                                    </span>
                                </a>
                            </ng-container>
                        </ng-template>
                    </sh-select>
                </div>
            </div>
            <div class="form-inline d-block flex-row flex-nowrap daybook-filter">
                <div class="form-group custom-datepicker" (click)="showGiddhDatepicker($event)">
                    <i class="icon-calender calendar-addon"></i>
                    <input type="text" name="selectedDateRange" [value]="(selectedDateRangeUi) ? selectedDateRangeUi : ''" class="giddh-datepicker date-range-picker border-radius-2"/>
                </div>
                <div class="form-group cursor-pointer">
                    <div class="advance-icon align-items-center" tooltip="Advance Search" (click)="onOpenAdvanceSearch()">
                        <span class="icon-advance-filter"></span>
                    </div>
                </div>
                <div class="form-group expand-collapse-btn">

                    <button type="button" class="btn btn-default" (click)="toggleExpand()">{{ isAllExpanded ? 'Collapse All' :
                              'Expand All'}}
                    </button>

                </div>
                <div class="clear-filter form-group" *ngIf="showAdvanceSearchIcon">
                    <button class="btn btn-filter" (click)="initialRequest();">
                        <span class="icon-cross"></span> Clear Filter
                    </button>
                </div>
                <div class="expand-export">
                    <button type="button" class="btn btn-default expand-btn-hide-desktop" (click)="toggleExpand()">{{ isAllExpanded ? 'Collapse All' :'Expand All'}}
                    </button>
                    <button type="button" class="btn btn-default export-btn pull-right mr-0"
                        (click)="exportDaybook()" [disabled]="!((daybookData$ | async)?.entries?.length > 0)">Export</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="box clearfix mr-t15">
        <div class="text-center mr-b2 transaction-report">
            <p>Transaction Report</p>
            <p>{{daybookQueryRequest.from }} - {{ daybookQueryRequest.to}}</p>
        </div>

        <div class="clearfix trial-balance table-responsive">

            <table class="tb-head table-bordered table basic on-mobile-view">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Particular</th>
                        <th>Vch. Name</th>
                        <th class=" text-right">Vch. No.</th>
                        <th class=" text-right">Debit Amt</th>
                        <th class=" text-right">Credit Amt</th>

                        <ng-container *ngIf="isEntryExpanded">
                            <th>Product/Service
                            </th>
                            <th class=" text-right">Qty.
                            </th>
                            <th>Unit
                            </th>
                            <th class=" text-right">Rate
                            </th>
                            <th>HSN/SAC
                            </th>
                            <th>SKU
                            </th>
                            <th>Warehouse
                            </th>
                        </ng-container>
                    </tr>
                </thead>

                <tbody *ngFor="let entry of (daybookData$ | async)?.entries" (click)="expandEntry(entry);"
                    class="daybook-table-tbody">
                    <tr>
                        <td data-title="Date">{{ entry.entryDate }}</td>
                        <td data-title="Particular">{{ entry.particular.name }}</td>
                        <td data-title="Vch. Name">{{ entry.voucherName }}</td>
                        <td class="text-right" data-title="Vch. No.">{{ entry.voucherNo }}</td>
                        <td class="text-right" data-title="Debit Amt">{{ entry.debitAmount || 0 |giddhCurrency }}</td>
                        <td class="text-right" data-title="Credit Amt">{{ entry.creditAmount || 0 |giddhCurrency}}</td>
                        <td *ngIf="isEntryExpanded" colspan="7"> </td>
                    </tr>
                    <ng-container *ngIf="entry !== undefined && entry.isExpanded">
                        <tr *ngFor="let details of entry.otherTransactions">
                            <td class="hide-td"></td>
                            <td data-title="Particular">{{ details.particular.name }}</td>
                            <td class="hide-td"></td>
                            <td class="hide-td"></td>
                            <td class="text-right" data-title="Debit Amt">
                                <span *ngIf="details.type === 'DEBIT'">{{ details.amount || 0 |giddhCurrency}}</span>
                                <span *ngIf="details.type !== 'DEBIT'">-</span>

                            </td>
                            <td class="text-right" data-title="Credit Amt">
                                <span *ngIf="details.type === 'CREDIT'">{{ details.amount|| 0  |giddhCurrency}}</span>
                                <span *ngIf="details.type !== 'CREDIT'">-</span>
                            </td>
                            <ng-container *ngIf="isEntryExpanded">
                                <td>{{details.inventory?details.inventory.stock.name:''}}
                                </td>
                                <td *ngIf="details.inventory" class=" text-right">{{details.inventory.quantity |giddhCurrency}}
                                </td>
                                <td *ngIf="!details.inventory" class=" text-right">{{'-'}}
                                </td>
                                <td>{{details.inventory?details.inventory.unit.name:''}}
                                </td>
                                <td *ngIf="details.inventory" class=" text-right">{{details.inventory.rate |giddhCurrency}}
                                </td>
                                <td *ngIf="!details.inventory" class=" text-right">{{'-'}}
                                </td>
                                <td>{{details.inventory?details.inventory.hsnNumber? details.inventory.hsnNumber: details.inventory.sacNumber:''}}
                                </td>
                                <td>{{details.inventory?details.inventory.skuCode:''}}
                                </td>
                                <td class="warehouse-name">{{details.inventory?details.inventory.warehouse.name:''}}
                                </td>
                            </ng-container>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>

        <div class="mr-t2 text-center">
            <small class="grey" *ngIf="(daybookData$ | async)?.totalItems">{{(daybookData$ | async)?.totalItems}}
                Transactions
                | {{(daybookData$ | async)?.totalPages}} Pages
            </small>
            <small class="grey" *ngIf="!((daybookData$ | async)?.totalItems)">0 Transactions | 0 Pages</small>
        </div>

        <!-- pagination -->
        <div class="mt-1">
            <pagination [totalItems]="daybookData?.totalItems" [(ngModel)]="daybookData.page" [maxSize]="5" class="pagination-sm" [boundaryLinks]="true" [itemsPerPage]="daybookData?.count" [rotate]="false" (pageChanged)="pageChanged($event)">
            </pagination>
        </div>
        <!-- pagination -->

    </div>
</div>
</ng-container>

<!-- Advance search popup -->
<div bsModal #advanceSearchModel="bs-modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <daybook-advance-search-model *ngIf="isAdvanceSearchOpened" #daybookAdvanceSearch [startDate]="daybookQueryRequest.from"
                [endDate]="daybookQueryRequest.to" (closeModelEvent)="closeAdvanceSearchPopup($event)">
            </daybook-advance-search-model>
        </div>
    </div>
</div>
<!-- ./Advance  search popup -->

<!-- export ladger popup -->
<div bsModal #exportDaybookModal="bs-modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <export-daybook (closeExportDaybookModal)="hideExportDaybookModal($event)"></export-daybook>
        </div>
    </div>
</div>
<!-- ./ export ladger popup -->
<ng-template #datepickerTemplate>
    <div class="datepicker-modal">
        <div class="modal-body">
            <app-datepicker-wrapper [inputStartDate]="selectedDateRange?.startDate" [inputEndDate]="selectedDateRange?.endDate" [alwaysShowCalendars]="true" [ranges]="datePickerOption" [selectedRangeLabel]="selectedRangeLabel" [showCustomRangeLabel]="true" [showClearButton]="false"
                                    [showCancel]="true" [linkedCalendars]="true" [showDropdowns]="true" [locale]="{applyLabel: 'Done'}" (rangeClicked)="dateSelectedCallback($event)" (datesUpdated)="dateSelectedCallback($event)" [keepCalendarOpeningWithRange]="false" [showRangeLabelOnInput]="false"
                                    [dateFieldPosition]="dateFieldPosition"></app-datepicker-wrapper>
        </div>
    </div>
</ng-template>
