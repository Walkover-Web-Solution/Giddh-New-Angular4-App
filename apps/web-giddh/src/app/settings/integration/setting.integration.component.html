<ng-container
    appTranslate
    [file]="'settings/integration'"
    (localeData)="localeData = $event"
    (commonLocaleData)="commonLocaleData = $event"
>
    <div class="clearfix">
        <mat-tab-group
            [ngClass]="{ 'tab-integration': true, 'hide-payment-tab': !isIndianCompany }"
            id="tab-integration"
        >
            <!-- <tab (selectTab)="loadSmsData($event); tabChanged('sms');">
                <ng-template tabHeading>
                    <span class="icon-chat2"></span> {{localeData?.sms?.tab_heading}}
                </ng-template>

                <div class="box clearfix">
                    <h3 class="font-20 bold mb-2">{{localeData?.sms?.form_heading}}</h3>
                    <form #msgform="ngForm" (ngSubmit)="onSubmitMsgform(msgform)" class="smsForm">
                        <section ngModelGroup="smsFormObj" #smsFormObjCtrl="ngModelGroup">
                            <div class="row">
                                <div class="form-group col-md-5 col-lg-3">

                                    <label>{{localeData?.sms?.auth_key_label}}</label>
                                    <br>
                                    <input type="text" [placeholder]="localeData?.sms?.auth_key_placeholder"
                                        class="form-control" [ngModel]="smsFormObj.authKey" name="authKey" required />

                                </div>
                                <div class="form-group col-md-5 col-lg-3">
                                    <label>{{localeData?.sms?.sender_id_label}}</label>
                                    <br>
                                    <input type="text" [placeholder]="localeData?.sms?.sender_id_placeholder"
                                        class="form-control" [ngModel]="smsFormObj.senderId" name="senderId" required />
                                </div>
                                <div class="form-group col-md-2 col-lg-3">
                                    <div class="empty-label">
                                        <label>&nbsp;</label>
                                        <br>
                                        <button type="submit" class="btn btn-success mr-r1"
                                            [disabled]="smsFormObjCtrl.invalid">{{commonLocaleData?.app_save}}</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </form>
                </div>
            </tab> -->

            <mat-tab [label]="localeData?.communication?.tab_heading">
                <app-setting-campaign></app-setting-campaign>
            </mat-tab>

            <mat-tab [label]="localeData?.email?.tab_heading" (selectTab)="loadEmailData($event); tabChanged('email')">
                <ng-template> <span class="icon-mail"></span> {{ localeData?.email?.tab_heading }} </ng-template>

                <div class="box clearfix mb-2">
                    <h3 class="section-head">{{ localeData?.email?.gmail_integration }}</h3>
                    <div class="d-flex gmail-integration-message">
                        <ng-container *ngIf="!(isGmailIntegrated$ | async)">
                            <a *ngIf="!isElectron" class="btn btn-primary" [href]="gmailAuthCodeUrl$ | async">{{
                                localeData?.email?.connect_gmail
                            }}</a>

                            <a
                                *ngIf="isElectron"
                                class="btn btn-primary"
                                href="javascript:void(0);"
                                (click)="gmailIntegration('google')"
                                >{{ localeData?.email?.connect_gmail }}</a
                            >
                        </ng-container>

                        <h4 *ngIf="isGmailIntegrated$ | async" class="text-success align-self-center">
                            {{ localeData?.email?.gmail_connected }}
                        </h4>
                        <button
                            *ngIf="isGmailIntegrated$ | async"
                            class="btn btn-danger mr-l2"
                            (click)="removegmailintegration.toggle()"
                        >
                            {{ localeData?.email?.remove_account }}
                        </button>
                    </div>
                </div>

                <!--remove account integration confirmation modal-->
                <div bsModal #removegmailintegration="bs-modal" class="modal fade" role="dialog">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <confirm-modal
                                [title]="localeData?.email?.remove_account_title"
                                [body]="localeData?.email?.remove_account_message"
                                (cancelCallBack)="removegmailintegration.toggle()"
                                (successCallBack)="removeGmailAccount(); removegmailintegration.toggle()"
                            >
                            </confirm-modal>
                        </div>
                    </div>
                </div>

                <div class="box clearfix">
                    <h3 class="font-20 bold mb-2">{{ localeData?.email?.form_heading }}</h3>
                    <form #emailform="ngForm" (ngSubmit)="onSubmitEmailform(emailform)">
                        <div class="row">
                            <div class="form-group col-md-5 col-lg-3">
                                <label>{{ localeData?.email?.auth_key_label }}</label>
                                <br />
                                <input
                                    type="text"
                                    [placeholder]="localeData?.email?.auth_key_placeholder"
                                    class="form-control"
                                    [ngModel]="emailFormObj.authKey"
                                    name="authKey"
                                    required
                                />
                            </div>
                            <div class="form-group col-md-5 col-lg-3">
                                <label>{{ localeData?.email?.email_subject_label }}</label>
                                <br />
                                <input
                                    type="text"
                                    [placeholder]="localeData?.email?.email_subject_placeholder"
                                    class="form-control"
                                    [ngModel]="emailFormObj.subject"
                                    name="subject"
                                    required
                                />
                            </div>
                            <div class="form-group col-md-2 col-lg-3 empty-label">
                                <label>&nbsp;</label>
                                <br />
                                <button type="submit" class="btn btn-success mr-r1" [disabled]="emailform.invalid">
                                    {{ commonLocaleData?.app_save }}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </mat-tab>

            <mat-tab
                [label]="localeData?.collection?.tab_heading"
                (selectTab)="loadCollectionData($event); tabChanged('collection')"
            >
                <ng-template> <span class="icon-card"></span> {{ localeData?.collection?.tab_heading }} </ng-template>

                <div class="box clearfix mb-2">
                    <h3 class="font-20 bold mb-2">{{ localeData?.collection?.razorpay_form_heading }}</h3>
                    <form #razorPayform="ngForm" novalidate class="">
                        <div class="row">
                            <div class="form-group col-lg-4 col-md-6 col-xs-12">
                                <label
                                    >{{ localeData?.collection?.key_id_label }}
                                    <span class="required">*</span>
                                </label>
                                <input
                                    class="form-control"
                                    type="text"
                                    [placeholder]="localeData?.collection?.key_id_placeholder"
                                    name="razorPayObj.userName"
                                    [(ngModel)]="razorPayObj.userName"
                                    required
                                    autocomplete="off"
                                />
                            </div>
                            <div class="form-group col-lg-4 col-md-6 col-xs-12">
                                <label
                                    >{{ localeData?.collection?.secret_key_label }}
                                    <span class="required">*</span>
                                </label>
                                <input
                                    class="form-control"
                                    type="password"
                                    [placeholder]="localeData?.collection?.secret_key_placeholder"
                                    name="razorPayObj.password"
                                    [(ngModel)]="razorPayObj.password"
                                    required
                                    autocomplete="off"
                                />
                            </div>
                        </div>
                        <div>
                            <div class="row">
                                <div class="form-group col-lg-4 col-md-6 col-xs-12">
                                    <div>
                                        <label>{{ localeData?.collection?.link_account_label }}</label>
                                        <div class="input-group">
                                            <sh-select
                                                class="linked-account"
                                                [placeholder]="localeData?.collection?.link_account_placeholder"
                                                name="razorPayObj.account"
                                                [(ngModel)]="razorPayObj.account.uniqueName"
                                                [options]="accounts$ | async"
                                                (selected)="selectAccount($event)"
                                                [forceClearReactive]="forceClearLinkAccount$ | async"
                                                [enableDynamicSearch]="true"
                                                [isPaginationEnabled]="true"
                                                (scrollEnd)="handleScrollEnd()"
                                                (dynamicSearchedQuery)="onAccountSearchQueryChanged($event)"
                                                [fixedValue]="razorPayObj?.account?.name"
                                                [defaultValue]="razorPayObj?.account?.name"
                                            >
                                            </sh-select>
                                            <div
                                                class="input-group-addon cp"
                                                *ngIf="razorPayObj?.account?.uniqueName && razorPayObj?.account?.name"
                                            >
                                                <span (click)="unlinkAccountFromRazorPay()" class="icon-trash"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group col-lg-4 col-md-6 col-xs-12 mr-t1 empty-label" id="inlnImg">
                                    <label>&nbsp;</label>
                                    <br />
                                    <ngx-switch
                                        [(status)]="razorPayObj.autoCapturePayment"
                                        [onText]="commonLocaleData?.app_on"
                                        [offText]="commonLocaleData?.app_off"
                                        [onColor]="bootstrapToggleSwitch?.On"
                                        [offColor]="bootstrapToggleSwitch?.Off"
                                        [size]="bootstrapToggleSwitch?.Size"
                                    >
                                    </ngx-switch>

                                    {{ localeData?.collection?.automatic_capture_on_payment }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-12 form-group">
                                <button
                                    *ngIf="!updateRazor"
                                    class="btn btn-success"
                                    [disabled]="razorPayform.invalid"
                                    (click)="saveRazorPayDetails()"
                                >
                                    {{ commonLocaleData?.app_save }}
                                </button>
                                <button
                                    *ngIf="updateRazor"
                                    class="btn btn-success"
                                    [disabled]="razorPayform.invalid"
                                    (click)="updateRazorPayDetails()"
                                >
                                    {{ commonLocaleData?.app_update }}
                                </button>
                                <button *ngIf="updateRazor" class="btn btn-danger" (click)="deleteRazorPayDetails()">
                                    {{ commonLocaleData?.app_delete }}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </mat-tab>

            <mat-tab
                [label]="localeData?.ecommerce?.tab_heading"
                (selectTab)="loadEcommerceData($event); tabChanged('ecommerce')"
            >
                <ng-template> <span class="icon-ecomm"></span> {{ localeData?.ecommerce?.tab_heading }} </ng-template>
                <div class="mr-t2 box clearfix">
                    <h3 class="section-head mb-2">{{ localeData?.ecommerce?.shopify_form_heading }}</h3>
                    <span *ngIf="isEcommerceShopifyUserVerified">{{
                        localeData?.ecommerce?.shopify_connected_message
                    }}</span>
                    <a
                        href="https://shopify.giddh.com/signup.php"
                        target="_blank"
                        *ngIf="!isEcommerceShopifyUserVerified"
                    >
                        <span>{{ localeData?.ecommerce?.connect_shopify }}</span></a
                    >
                </div>
            </mat-tab>

            <mat-tab
                [label]="localeData?.payment?.tab_heading"
                (selectTab)="loadPaymentData($event); tabChanged('payment')"
                [hidden]="!isIndianCompany"
            >
                <div *ngIf="isIndianCompany" class="clearfix box">
                    <ng-template>
                        <span class="icon-payment"></span> {{ localeData?.payment?.tab_heading }}
                    </ng-template>
                    <div class="mb-2 bank-logo">
                        <img src="{{ imgPath }}ICICI-logo.png" />
                    </div>
                    <div class="row">
                        <div class="form-group mr-l2">
                            <button type="button" class="btn btn-sky-blue mr-r2" (click)="openCreateNewAccountModal()">
                                {{ localeData?.payment?.connect_new_account }}
                            </button>
                            <span class="button-separator">|</span> <br />
                            <a
                                href="https://giddh.com/help/how-to-integrate-icici-bank-account-with-giddh"
                                target="_blank"
                                class="font-12"
                                >{{ localeData?.payment?.learn_connect }}</a
                            >
                        </div>
                        <div class="form-group mr-l1">
                            <p class="mb-4 mr-l05 font-12">
                                <a
                                    class="btn icici-button"
                                    href="https://cadigital.icicibank.com/SmartFormWeb/apps/services/www/SmartFormWeb/desktopbrowser/default/index.html?source=BC-application-Giddh#/"
                                    target="_blank"
                                    ><span class="icon-icici-logo"
                                        ><span class="path1"></span><span class="path2"></span
                                        ><span class="path3"></span
                                    ></span>
                                    {{ localeData?.payment?.open_new_current_account }}</a
                                >
                            </p>
                        </div>
                    </div>

                    <div class="connected-accounts">
                        <b class="font-14" *ngIf="!isLoading && connectedBankAccounts?.length > 0">{{
                            localeData?.payment?.connected_accounts
                        }}</b
                        ><br />
                        <giddh-page-loader [cssClass]="'mt-0 mb-0'" *ngIf="isLoading"></giddh-page-loader>
                        <ng-container *ngIf="!isLoading && connectedBankAccounts?.length > 0">
                            <div
                                class="account-wrapper"
                                *ngFor="let bankAccount of connectedBankAccounts; trackBy: trackByAccountUniqueName"
                            >
                                <div class="account-info-background width-100 font-14 row">
                                    <div class="col-md-4">
                                        <span class="field-label">{{ localeData?.payment?.account_number_label }}</span
                                        ><br />
                                        <span class="account-number mt-2 font-16 inline"
                                            ><b>{{ bankAccount?.iciciDetailsResource?.accountNumber }}</b></span
                                        >
                                    </div>
                                    <div class="col-md-4">
                                        <span class="field-label">{{ localeData?.payment?.linked_account }}</span
                                        ><br />
                                        <span class="width-100 view-only-field inline">{{
                                            bankAccount?.account?.name
                                        }}</span>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="field-label">{{ localeData?.payment?.payment_updates }}</span
                                        ><br />
                                        <span
                                            class="payment-updates view-only-field inline"
                                            *ngIf="bankAccount?.iciciDetailsResource?.paymentAlerts?.length > 0"
                                        >
                                            <ng-container
                                                *ngFor="
                                                    let alert of bankAccount?.iciciDetailsResource?.paymentAlerts;
                                                    let i = index;
                                                    trackBy: trackByAlertUniqueName
                                                "
                                                >{{ alert?.name
                                                }}{{
                                                    i < bankAccount?.iciciDetailsResource?.paymentAlerts?.length - 1
                                                        ? ", "
                                                        : ""
                                                }}</ng-container
                                            >
                                        </span>
                                        <span class="mr-l1 action-div">
                                            <a
                                                href="javascript:;"
                                                class="icon-edit-pencil"
                                                (click)="openEditAccountModal(bankAccount)"
                                            ></a>
                                        </span>
                                    </div>
                                </div>
                                <div class="font-14">
                                    <ng-container *ngIf="bankAccount?.iciciDetailsResource?.payor?.length > 0">
                                        <div
                                            class="mt-2"
                                            *ngFor="
                                                let payor of bankAccount?.iciciDetailsResource?.payor;
                                                trackBy: trackByPayorUniqueName
                                            "
                                        >
                                            <div class="width-100">
                                                <div class="col-md-4 v-align-top inline">
                                                    <span class="field-label">{{
                                                        localeData?.payment?.login_id_label
                                                    }}</span
                                                    ><br />
                                                    <span class="width-100 disabled-field inline">{{
                                                        payor?.loginId
                                                    }}</span
                                                    ><br />
                                                    <span class="font-12 field-label">{{ payor?.user?.name }}</span>
                                                </div>
                                                <div class="col-md-4 v-align-top inline">
                                                    <span class="limit-upto field-label">{{
                                                        localeData?.payment?.limit_upto
                                                    }}</span
                                                    ><br />
                                                    <span class="width-100 disabled-field inline limit-upto"
                                                        >{{
                                                            payor?.duration === unlimitedLimit
                                                                ? commonLocaleData?.app_amount_limit?.unlimited
                                                                : activeCompany?.baseCurrencySymbol +
                                                                  " " +
                                                                  (payor?.maxAmount | giddhCurrency)
                                                        }}
                                                        <span
                                                            class="pull-right payor-duration font-12"
                                                            *ngIf="payor?.duration !== unlimitedLimit"
                                                            >/ {{ payor?.duration | titlecase }}</span
                                                        ></span
                                                    ><br />
                                                    <span class="limit-upto font-12 field-label"
                                                        >{{ localeData?.payment?.used }}
                                                        {{ payor?.usedAmount | giddhCurrency }}</span
                                                    >
                                                </div>
                                                <div class="col-md-4 v-align-top inline mt-2">
                                                    <br />
                                                    <span
                                                        class="account-approval-status pending-approval"
                                                        *ngIf="!payor?.isConnected"
                                                        ><i class="icon-alert-2"></i>
                                                        {{ localeData?.payment?.pending_self_approval }}</span
                                                    >
                                                    <span
                                                        class="account-approval-status approved"
                                                        *ngIf="payor?.isConnected"
                                                        ><i class="icon-success"></i>
                                                        {{ localeData?.payment?.connected }}</span
                                                    >
                                                    <span class="mr-l15 user-action-div">
                                                        <a
                                                            *ngIf="payor?.isConnected"
                                                            href="javascript:;"
                                                            class="icon-edit-pencil"
                                                            (click)="openEditAccountUserModal(bankAccount, payor)"
                                                        ></a>
                                                        <a
                                                            href="javascript:;"
                                                            class="fa fa-trash mr-l2"
                                                            (click)="
                                                                showDeleteBankAccountLoginConfirmationModal(
                                                                    bankAccount,
                                                                    payor
                                                                )
                                                            "
                                                        ></a>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="inline mt-2 mb-2" *ngIf="!payor?.isConnected">
                                                <div class="col-md-12">
                                                    <p
                                                        class="font-12"
                                                        [innerHTML]="localeData?.payment?.approval_request_sent"
                                                    ></p>
                                                    <p class="font-10">
                                                        {{ localeData?.payment?.approval_request_accepted }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <button
                                        type="button"
                                        class="btn btn-light-blue bold font-14 mt-2 mr-l15"
                                        (click)="openCreateNewAccountUserModal(bankAccount)"
                                    >
                                        {{ localeData?.payment?.add_more_users }}
                                    </button>
                                    <a class="btn icici-button font-12 mt-2 pull-right mr-0" href="javascript:;"
                                        ><span class="icon-icici-logo"
                                            ><span class="path1"></span><span class="path2"></span
                                            ><span class="path3"></span
                                        ></span>
                                        {{ localeData?.payment?.get_instant_overdraft }}</a
                                    >
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </mat-tab>
            <mat-tab
                [label]="localeData?.tally?.heading"
                (selectTab)="tabChanged('tally')"
                *ngIf="voucherApiVersion === 2"
            >
                <ng-template> <span class="icon-card"></span>{{ localeData?.tally?.heading }}</ng-template>
                <div class="box clearfix mb-2">
                    <div class="form-group magic-link-container col-md-9 col-lg-7 d-flex align-items-center">
                        <label class="bold">{{ localeData?.tally?.api_url }}</label>
                        <mat-form-field appearance="fill">
                            <input
                                #apiUrlInput
                                matInput
                                class="dashed tally-url"
                                [readonly]="true"
                                type="text"
                                [(ngModel)]="apiUrl"
                            />
                        </mat-form-field>
                        <span class="input-group-btn">
                            <i
                                class="icon-copy-file"
                                (click)="copyUrl()"
                                [ngxClipboard]="apiUrlInput"
                                [tooltip]="commonLocaleData?.app_copy"
                            ></i>
                        </span>
                        <span class="success copied-url" *ngIf="isCopied">{{ localeData?.tally?.copied }}</span>
                    </div>
                    <div class="form-group clearfix mb-0 doc-link">
                        <a target="_blank" class="btn btn-link" [routerLink]="['/pages/user-details/auth-key']">{{
                            localeData?.email?.auth_key_label
                        }}</a>
                        <a
                            target="_blank"
                            class="btn btn-link"
                            href="https://giddh.com/help/sync-with-tally-1591360375828781"
                            >{{ localeData?.tally?.help_documentation }}</a
                        >
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </div>
    <div bsModal #createNewAccountModal="bs-modal" [config]="{ backdrop: 'static' }" class="modal" role="dialog">
        <div class="modal-dialog account-modal" *ngIf="createNewAccountModal?.isShown">
            <div class="modal-content">
                <icici-account-create-edit
                    [commonLocaleData]="commonLocaleData"
                    (getAllBankAccounts)="getAllBankAccounts()"
                    (closeModalEvent)="closeCreateNewAccountModal()"
                >
                </icici-account-create-edit>
            </div>
        </div>
    </div>
    <div bsModal #editAccountModal="bs-modal" [config]="{ backdrop: 'static' }" class="modal" role="dialog">
        <div class="modal-dialog account-modal" *ngIf="editAccountModal?.isShown">
            <div class="modal-content">
                <icici-account-create-edit
                    [commonLocaleData]="commonLocaleData"
                    [activeBankAccount]="activeBankAccount"
                    (getAllBankAccounts)="getAllBankAccounts()"
                    (closeModalEvent)="closeEditAccountModal()"
                >
                </icici-account-create-edit>
            </div>
        </div>
    </div>
    <div bsModal #createNewAccountUserModal="bs-modal" [config]="{ backdrop: 'static' }" class="modal" role="dialog">
        <div class="modal-dialog user-modal" *ngIf="createNewAccountUserModal?.isShown">
            <div class="modal-content">
                <icici-payor-account-create-edit
                    [commonLocaleData]="commonLocaleData"
                    [activeBankAccount]="activeBankAccount"
                    (getAllBankAccounts)="getAllBankAccounts()"
                    (closeModalEvent)="closeCreateNewAccountUserModal()"
                ></icici-payor-account-create-edit>
            </div>
        </div>
    </div>
    <div bsModal #editAccountUserModal="bs-modal" [config]="{ backdrop: 'static' }" class="modal" role="dialog">
        <div class="modal-dialog user-modal" *ngIf="editAccountUserModal?.isShown">
            <div class="modal-content">
                <icici-payor-account-create-edit
                    [commonLocaleData]="commonLocaleData"
                    [activeBankAccount]="activeBankAccount"
                    [activePayorAccount]="activePayorAccount"
                    (getAllBankAccounts)="getAllBankAccounts()"
                    (closeModalEvent)="closeEditAccountUserModal()"
                >
                </icici-payor-account-create-edit>
            </div>
        </div>
    </div>
    <div
        bsModal
        #confirmationModal="bs-modal"
        [config]="{ backdrop: 'static', keyboard: false }"
        class="modal fade"
        role="dialog"
    >
        <div class="modal-dialog modal-md" *ngIf="confirmationModal?.isShown">
            <div class="modal-content">
                <confirm-modal
                    [body]="localeData?.payment?.delete_login | replace: '[LOGIN_ID]':activeBankAccount?.loginId"
                    (cancelCallBack)="confirmationModal?.hide()"
                    (successCallBack)="deleteBankAccountLogin(true)"
                >
                </confirm-modal>
            </div>
        </div>
    </div>
</ng-container>
