<ng-container
    appTranslate
    [file]="'settings/campaign'"
    (localeData)="localeData = $event"
    (commonLocaleData)="commonLocaleData = $event"
    (translationComplete)="translationComplete($event)"
>
    <div class="msg91-container" *ngIf="!showTriggerForm">
        <div class="menu" *ngIf="communicationPlatforms?.MSG91?.isConnected">
            <button mat-icon-button disableRipple id="edit-model-basic" [matMenuTriggerFor]="beforeMenu">
                <span class="icon-dots-three-vertical"></span>
            </button>
            <mat-menu #beforeMenu="matMenu" xPosition="before">
                <button mat-menu-item (click)="editCommunicationPlatform = 'MSG91'">
                    <span>{{ localeData?.communication?.edit_platform }}</span>
                </button>
                <button mat-menu-item (click)="deleteCommunicationPlatform(communicationPlatforms?.MSG91?.uniqueName)">
                    <span>{{ localeData?.communication?.remove_platform }}</span>
                </button>
            </mat-menu>
        </div>
        <div class="image" *ngIf="!communicationPlatforms?.MSG91?.isConnected">
            <img src="{{ imgPath }}msgOne.png" class="logo" alt="" />
            <img src="{{ imgPath }}msgTwo.png" class="msg" alt="" />
        </div>
        <div class="image" *ngIf="communicationPlatforms?.MSG91?.isConnected">
            <img src="{{ imgPath }}msgOne-color.png" class="logo" alt="" />
            <img src="{{ imgPath }}msgTwo-color.png" class="msg" alt="" />
        </div>
        <div class="integrate mini-icons" *ngIf="communicationPlatforms?.MSG91?.isConnected">
            <img src="{{ imgPath }}msg91.png" alt="" />
            <img src="{{ imgPath }}p1.png" alt="" />
            <img src="{{ imgPath }}whatsapp.png" alt="" />
            <img src="{{ imgPath }}msg1.png" alt="" />
            <img src="{{ imgPath }}91091.png" alt="" />
            <img src="{{ imgPath }}say1.png" alt="" />
        </div>
        <div class="integrate" *ngIf="!communicationPlatforms?.MSG91?.isConnected">
            <p>{{ localeData?.communication?.integrate_now }}</p>
        </div>
    </div>
    <div
        class="form"
        *ngIf="
            (!isCommunicationPlatformsLoading && !communicationPlatforms?.MSG91?.isConnected) ||
            editCommunicationPlatform === 'MSG91'
        "
    >
        <div class="input-field">
            <p class="label auth-label">
                {{ communicationPlatforms?.MSG91?.fields?.auth_key?.label
                }}<span *ngIf="communicationPlatforms?.MSG91?.fields?.auth_key?.mandatory">*</span>
            </p>
            <text-field
                [type]="'text'"
                [cssClass]="'form-control mat-field-border auth_key_input '"
                [name]="'title'"
                [placeholder]="localeData?.communication?.auth_key"
                [(ngModel)]="communicationPlatformAuthModel.authFields[0].value"
                [ngClass]="{ 'fields-error': mandatoryFields.authKey }"
            >
            </text-field>
        </div>
        <div class="input-field">
            <p class="label auth-label">{{ communicationPlatforms.MSG91?.fields?.whitelist_ips?.label }}</p>
            <text-field
                [type]="'text'"
                [cssClass]="'form-control mat-field-border auth_key_ips'"
                [name]="'auth'"
                [readonly]="true"
                [placeholder]="localeData?.communication?.whitelist_ips"
                [(ngModel)]="communicationPlatforms.MSG91.fields.whitelist_ips.value"
            >
            </text-field>
        </div>
        <button
            mat-flat-button
            color="primary"
            class="mt-1"
            [disabled]="isCommunicationPlatformVerificationInProcess"
            (click)="verifyCommunicationPlatform('MSG91')"
        >
            {{ localeData?.communication?.verify_integration }}
        </button>
    </div>

    <ng-container *ngIf="!editCommunicationPlatform">
        <button
            class="new-trigger"
            mat-flat-button
            color="primary"
            *ngIf="!showTriggerForm && communicationPlatforms?.MSG91?.isConnected"
            (click)="toggleTriggerForm()"
        >
            {{ localeData?.communication?.create_new_trigger }}
        </button>

        <div
            class="table-one table-content"
            *ngIf="
                !isActiveTriggersLoading &&
                !showTriggerForm &&
                communicationPlatforms?.MSG91?.isConnected &&
                activeTriggersDataSource?.length
            "
        >
            <table mat-table [dataSource]="activeTriggersDataSource" class="mat-elevation-z8 giddh-table table">
                <ng-container matColumnDef="title">
                    <th class="active-trigger-title-width" mat-header-cell *matHeaderCellDef>
                        {{ localeData?.communication?.active_triggers }}
                    </th>
                    <td mat-cell *matCellDef="let element">{{ element.title }}</td>
                </ng-container>

                <ng-container matColumnDef="type">
                    <th class="channel-width" mat-header-cell *matHeaderCellDef>
                        {{ localeData?.communication?.type }}
                    </th>
                    <td mat-cell *matCellDef="let element">{{ element.type }}</td>
                </ng-container>

                <ng-container matColumnDef="argsMapping">
                    <th class="args-mapping-width" mat-header-cell *matHeaderCellDef>
                        {{ localeData?.communication?.fields_mapping }}
                    </th>
                    <td mat-cell *matCellDef="let element">{{ element.argsMapping }}</td>
                </ng-container>

                <ng-container matColumnDef="createdAt">
                    <th class="created-at-width" mat-header-cell *matHeaderCellDef>
                        {{ localeData?.communication?.created_at }}
                    </th>
                    <td mat-cell *matCellDef="let element">
                        {{ element.createdAt }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="action">
                    <th class="icons-left" mat-header-cell *matHeaderCellDef>
                        {{ localeData?.communication?.action }}
                    </th>
                    <td mat-cell *matCellDef="let element">
                        <button
                            class="small-button"
                            mat-flat-button
                            color="primary"
                            (click)="updateTriggerStatus(element.uniqueName)"
                        >
                            {{
                                element?.isActive > 0
                                    ? localeData?.communication?.activated
                                    : localeData?.communication?.deactivated
                            }}
                        </button>
                        <img
                            class="icon-visibility cursor-pointer"
                            (click)="editTrigger(element, 'copy')"
                            src="{{ imgPath }}copy.svg"
                            alt=""
                        />
                        <img
                            class="mr-l2 icon-visibility cursor-pointer"
                            src="{{ imgPath }}edit.svg"
                            alt=""
                            (click)="editTrigger(element, 'update')"
                        />
                        <a href="javascript:;" (click)="deleteTrigger(element.uniqueName)"
                            ><img class="mr-l2 icon-visibility" src="{{ imgPath }}delete.svg"
                        /></a>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="activeTriggersColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: activeTriggersColumns"></tr>
            </table>
            <section class="no-logs" *ngIf="!activeTriggersDataSource?.length && !isActiveTriggersLoading">
                <div class="no-data">
                    <h1>{{ localeData?.communication?.no_triggers_found }}</h1>
                </div>
            </section>
        </div>
        <div
            class="pagination-wrapper"
            *ngIf="
                triggerObj?.totalPages > 1 &&
                !isActiveTriggersLoading &&
                !showTriggerForm &&
                activeTriggersDataSource?.length
            "
        >
            <pagination
                [totalItems]="triggerObj?.totalItems"
                [(ngModel)]="triggerObj.page"
                [maxSize]="5"
                class="pagination-sm"
                [boundaryLinks]="true"
                [itemsPerPage]="triggerObj?.count"
                [rotate]="false"
                (pageChanged)="pageChanged($event)"
                [firstText]="commonLocaleData?.app_first"
                [previousText]="commonLocaleData?.app_previous"
                [nextText]="commonLocaleData?.app_next"
                [lastText]="commonLocaleData?.app_last"
            ></pagination>
        </div>
    </ng-container>
    <!-- Page-6 to Page-9 -->
    <div class="trigger-form" *ngIf="!editCommunicationPlatform && showTriggerForm">
        <div class="trigger-form-left-side">
            <div class="create-trigger-head">
                <img class="return" src="{{ imgPath }}return.svg" alt="" (click)="backToListPage($event)" />
                <p class="trigger-heading">
                    {{
                        triggerMode === "create"
                            ? localeData?.communication?.create_trigger
                            : localeData?.communication?.edit_trigger
                    }}
                </p>
            </div>

            <div class="trigger-input">
                <p class="trigger-input-label">{{ localeData?.communication?.title }}<span>*</span></p>
                <text-field
                    [type]="'text'"
                    [cssClass]="'form-control mat-field-border'"
                    [placeholder]="localeData?.communication?.name_trigger"
                    [name]="'trigger'"
                    [(ngModel)]="createTrigger.title"
                    [ngClass]="{ 'fields-error': mandatoryFields.title }"
                >
                </text-field>
            </div>
            <div class="trigger-input">
                <p class="trigger-input-label">{{ localeData?.communication?.condition }}<span>*</span></p>
                <select-field
                    [cssClass]="'form-control mat-field-border'"
                    [placeholder]="localeData?.communication?.select_condition"
                    [options]="triggerCondition"
                    (selectedOption)="selectConditions($event?.value)"
                    [defaultValue]="createTrigger.condition.action.length ? createTrigger.condition.action[0] : ''"
                    [ngClass]="{ 'fields-error': mandatoryFields.condition }"
                ></select-field>
            </div>
            <div class="trigger-input">
                <p class="trigger-input-label">{{ localeData?.communication?.entity }}<span>*</span></p>
                <select-field
                    [cssClass]="'form-control mat-field-border'"
                    [placeholder]="localeData?.communication?.select_entity"
                    [options]="triggerEntity"
                    (selectedOption)="selectEntity($event?.value)"
                    [defaultValue]="createTrigger.condition.entity"
                    [ngClass]="{ 'fields-error': mandatoryFields.entity }"
                ></select-field>
            </div>
            <div class="trigger-input">
                <p class="trigger-input-label">{{ localeData?.communication?.sub_entity }}<span>*</span></p>
                <mat-select
                    name="subentity"
                    class="form-control mat-field-border sub-entity-trigger"
                    [placeholder]="localeData?.communication?.select_sub_entity"
                    multiple
                    [(ngModel)]="createTrigger.condition.subConditions[0].action"
                    (selectionChange)="selectSubEntity($event?.value)"
                    [ngClass]="{ 'fields-error': mandatoryFields.subConditions }"
                >
                    <mat-option
                        *ngFor="let action of subConditionAction"
                        [selected]="action?.isChecked"
                        [value]="action"
                        >{{ action }}</mat-option
                    >
                </mat-select>
            </div>
            <div class="trigger-input">
                <p class="trigger-input-label">{{ localeData?.communication?.campaign }}<span>*</span></p>
                <select-field
                    [cssClass]="'form-control mat-field-border'"
                    [placeholder]="localeData?.communication?.select_campaign"
                    [options]="campaignList"
                    (selectedOption)="selectCampaign($event, true)"
                    [defaultValue]="createTrigger.campaignDetails.campaignName"
                    [ngClass]="{ 'fields-error': mandatoryFields.campaignSlug }"
                ></select-field>
            </div>
            <button
                *ngIf="triggerMode === 'create' || triggerMode === 'copy'"
                mat-flat-button
                color="primary"
                (click)="createNewTrigger()"
                [disabled]="isInvalidTrigger"
            >
                {{
                    triggerMode === "create"
                        ? localeData?.communication?.create_trigger
                        : localeData?.communication?.save_trigger
                }}
            </button>
            <button
                *ngIf="triggerMode === 'update'"
                mat-flat-button
                color="primary"
                (click)="updateTrigger()"
                [disabled]="isInvalidTrigger"
            >
                {{
                    triggerMode === "create"
                        ? localeData?.communication?.create_trigger
                        : localeData?.communication?.update_trigger
                }}
            </button>
        </div>
        <div class="trigger-form-right-side" *ngIf="showVariableMapping">
            <div class="dropdown-box">
                <div class="compose-trigger-dropdowns">
                    <mat-form-field class="example-chip-list">
                        <mat-chip-list #chipListTo>
                            <mat-chip
                                *ngFor="let trigger of triggerToChiplist; let indx = index"
                                [selectable]="true"
                                [removable]="true"
                                (removed)="removeTo(trigger, indx)"
                            >
                                {{ trigger }}
                                <i class="icon-cross" matChipRemove></i>
                            </mat-chip>
                            <input
                                [placeholder]="localeData?.communication?.select_to"
                                [matAutocomplete]="auto1"
                                [matChipInputFor]="chipListTo"
                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                [matChipInputAddOnBlur]="true"
                                (matChipInputTokenEnd)="addTriggerTo($event)"
                                [ngClass]="{ 'chiplist-error': mandatoryFields.triggerToChiplist }"
                            />
                        </mat-chip-list>
                        <mat-autocomplete #auto1="matAutocomplete" (optionSelected)="selectTriggerTo($event)">
                            <mat-option *ngFor="let to of triggerToDropdown" [value]="to">
                                {{ to.label }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <br />
                    <mat-form-field class="example-chip-list">
                        <mat-chip-list #chipListBcc>
                            <mat-chip
                                *ngFor="let trigger of triggerBccChiplist; let indx = index"
                                [selectable]="true"
                                [removable]="true"
                                (removed)="removeBcc(trigger, indx)"
                            >
                                {{ trigger }}

                                <i class="icon-cross" matChipRemove></i>
                            </mat-chip>
                            <input
                                [placeholder]="localeData?.communication?.select_bcc"
                                [matAutocomplete]="auto2"
                                [matChipInputFor]="chipListBcc"
                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                [matChipInputAddOnBlur]="true"
                                (matChipInputTokenEnd)="addTriggerBcc($event)"
                            />
                        </mat-chip-list>
                        <mat-autocomplete #auto2="matAutocomplete" (optionSelected)="selectTriggerBcc($event)">
                            <mat-option *ngFor="let bcc of triggerBccDropdown" [value]="bcc">
                                {{ bcc.label }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <br />
                    <mat-form-field class="example-chip-list">
                        <mat-chip-list #chipListCc>
                            <mat-chip
                                *ngFor="let trigger of triggerCcChiplist; let indx = index"
                                [selectable]="true"
                                [removable]="true"
                                (removed)="removeCc(trigger, indx)"
                            >
                                {{ trigger }}

                                <i class="icon-cross" matChipRemove></i>
                            </mat-chip>
                            <input
                                [placeholder]="localeData?.communication?.select_cc"
                                [matAutocomplete]="auto3"
                                [matChipInputFor]="chipListCc"
                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                [matChipInputAddOnBlur]="true"
                                (matChipInputTokenEnd)="addTriggerCc($event)"
                            />
                        </mat-chip-list>
                        <mat-autocomplete #auto3="matAutocomplete" (optionSelected)="selectTriggerCc($event)">
                            <mat-option *ngFor="let cc of triggerCcDropdown" [value]="cc">
                                {{ cc.label }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                    <br />
                    <mat-checkbox
                        class="trigger-dropdown"
                        #sendVoucherPdf
                        color="primary"
                        name="voucherpdf"
                        [(ngModel)]="createTrigger.campaignDetails.sendVoucherPdf"
                        (change)="selectVoucherPdf($event.checked)"
                        ><span class="compose">{{ localeData?.communication?.send_voucher }}</span>
                    </mat-checkbox>
                </div>
                <br />
                <p class="compose" *ngIf="createTrigger.campaignDetails.argsMapping?.length">
                    {{ localeData?.communication?.variables }}
                </p>
                <mat-grid-list class="unit-mapping-grid-list" cols="3" gutterSize="0px" rowHeight="70px">
                    <form class="map-unit-value-form">
                        <mat-grid-tile
                            class="grid-box grid-box-content campaign-grid-tile"
                            *ngFor="let variables of createTrigger.campaignDetails.argsMapping"
                        >
                            <div class="unit-value">{{ variables.name }}</div>
                            <div class="map-unit-value">
                                <select-field
                                    [cssClass]="'form-control mat-field-border bottom-select-suggestion'"
                                    [placeholder]="localeData?.communication?.select_suggestions"
                                    [options]="fieldsSuggestion"
                                    (selectedOption)="variables.value = $event.value"
                                    [defaultValue]="variables?.value"
                                ></select-field>
                            </div>
                        </mat-grid-tile>
                    </form>
                </mat-grid-list>
                <br />
            </div>
        </div>
    </div>
</ng-container>
