<div class="recurring-container">


    <form #recurringForm="ngForm" novalidate class="form-inline input-grp-date-range-picker position-relative" (ngSubmit)="submit()">

        <div class="d-flex search-icon-block mr-b15"  *ngIf="isMobileScreen">
            <div (click)="openModal(template)">
                <i class="icon-search"></i>
            </div>
            <ng-template #template>
                <div class="modal-header">
                    <h4 class="modal-title bg pull-left">Search here...</h4>
                    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-view">
                        <div class="form-group">
                            <label class="d-block">Invoice Type</label>
                            <div class="ng-select-wrap">
                                <sh-select name="invoiceType" [placeholder]="'Select Account'"
                                    [(ngModel)]="filter.status" [options]="invoiceTypeOptions" [notFoundLink]="false"
                                    [multiple]="false" [ItemHeight]="33" [useInBuiltFilterForIOptionTypeItems]="true">
                                    <ng-template #optionTemplate let-option="option">
                                        <a href="javascript:void(0)" class="list-item">
                                            <div class="item">{{ option.label }}</div>
                                        </a>
                                    </ng-template>
                                </sh-select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="d-block">Interval</label>
                            <div class="ng-select-wrap">
                                <sh-select name="interval" [placeholder]="'Select Account'" [options]="intervalOptions"
                                    [notFoundLink]="false" [multiple]="false" [(ngModel)]="filter.duration"
                                    [ItemHeight]="33" [useInBuiltFilterForIOptionTypeItems]="true">
                                    <ng-template #optionTemplate let-option="option">
                                        <a href="javascript:void(0)" class="list-item">
                                            <div class="item">{{ option.label }}</div>
                                        </a>
                                    </ng-template>
                                </sh-select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="d-block">Last Invoice Date</label>
                            <div>
                                <giddh-datepicker name="lastInvoiceDate" [(ngModel)]="filter.lastInvoiceDate" [placeholder]="'Select Date'"></giddh-datepicker>
                            </div>
                        </div>
                        <div class="form-group search-invoice-filed">
                            <div class="search-invoice-no">
                                <label class="d-block">Search Invoice No.</label>
                                <div class="input-group">
                                    <input type="text" placeholder="Search Invoice No." class="w100"
                                        [formControl]="invoiceNumberInput" #invoiceSearch class="form-control" />
                                    <!--<i class="icon-search" (click)="showInvoiceNumberSearch = false;"></i>-->
                                </div>
                            </div>
                        </div>
                        <div class="form-group search-invoice-filed">
                            <div class="search-customer-no">
                                <div class="input-container">
                                    <label class="d-block">Search Customer Name</label>
                                    <input type="text" placeholder="Search Customer Name" class="w100"
                                        name="customerName" [formControl]="customerNameInput" #customerSearch
                                        class="form-control" />
                                    <!-- <i class="icon-search" (click)="showCustomerNameSearch = false;"></i> -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success btn-sm">Search</button>
                            <a class="cp" href="javascript: void 0">
                                <i aria-hidden="true" class="icon-refresh"
                                    tooltip="Reset Filter" *ngIf="showResetFilterButton" (click)="resetFilter()"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </ng-template>

        </div>
        <div class="recurring-form-wrapper">
            <div class="recurring-form" *ngIf="!isMobileScreen">
                <div class="form-group mr-r1">
                    <label class="d-block mr-r15">Invoice Type</label>
                    <div class="ng-select-wrap input-group">
                        <sh-select name="invoiceType" [placeholder]="'Select Account'" [(ngModel)]="filter.status"
                            [options]="invoiceTypeOptions" [notFoundLink]="false" [multiple]="false" [ItemHeight]="33"
                            [useInBuiltFilterForIOptionTypeItems]="true">
                            <ng-template #optionTemplate let-option="option">
                                <a href="javascript:void(0)" class="list-item">
                                    <div class="item">{{ option.label }}</div>
                                </a>
                            </ng-template>
                        </sh-select>
                    </div>
                </div>
                <div class="form-group mr-r1">
                    <label class="d-block mr-r15">Interval</label>
                    <div class="ng-select-wrap input-group">
                        <sh-select name="interval" [placeholder]="'Select Account'" [options]="intervalOptions"
                            [notFoundLink]="false" [multiple]="false" [(ngModel)]="filter.duration" [ItemHeight]="33"
                            [useInBuiltFilterForIOptionTypeItems]="true">
                            <ng-template #optionTemplate let-option="option">
                                <a href="javascript:void(0)" class="list-item">
                                    <div class="item">{{ option.label }}</div>
                                </a>
                            </ng-template>
                        </sh-select>
                    </div>
                </div>

                <div class="form-group mr-r1">
                    <label class="d-block mr-r15">Last Invoice Date</label>
                    <div class="input-group">
                        <giddh-datepicker name="lastInvoiceDate" [(ngModel)]="filter.lastInvoiceDate" [placeholder]="'Select Date'"></giddh-datepicker>
                    </div>
                </div>

                <div class="form-group mr-r1" *ngIf="isMobileScreen">
                    <div class="search-invoice-no">
                        <label class="d-block">Search Invoice No.</label>
                        <div class="input-group">
                            <input type="text" placeholder="Search Invoice No." class="w100" [formControl]="invoiceNumberInput"
                                #invoiceSearch class="form-control" />
                            <!--<i class="icon-search" (click)="showInvoiceNumberSearch = false;"></i>-->
                        </div>
                    </div>
                </div>
                <div class="form-group mr-r1" *ngIf="isMobileScreen">
                    <div class="search-customer-no">
                        <div class="input-container">
                            <label class="d-block">Search Customer Name</label>
                            <input type="text" placeholder="Search Customer Name" class="w100" name="customerName"
                                [formControl]="customerNameInput" #customerSearch class="form-control" />
                            <!-- <i class="icon-search" (click)="showCustomerNameSearch = false;"></i> -->
                        </div>
                    </div>
                </div>

                <div class="form-group mr-r1">
                    <label class="d-block">&nbsp;</label>
                    <button class="btn btn-success btn-sm">Search</button>
                    <a class="cp" href="javascript: void 0">
                        <i aria-hidden="true" class="icon-refresh" tooltip="Reset Filter" *ngIf="showResetFilterButton"
                            (click)="resetFilter()"></i>
                    </a>
                </div>
            </div>
            <div class="d-flex mb-2">
                <div class="more-dropdown" *ngIf="selectedItems.length < 0">
                    <div class="btn-group d-inline-block mr-b1" dropdown triggers="mouseover" #dp="bs-dropdown" (mouseleave)="dp.hide()">

                        <button dropdownToggle type="button" class="btn more-btn-dropdown dropdown-toggle"
                            aria-controls="dropdown-basic">
                            More
                            <span class="caret"></span>
                        </button>

                        <ul *dropdownMenu class="dropdown-menu" role="menu" aria-labelledby="button-basic">

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Bulk Note</a>
                            </li>

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Send Email</a>
                            </li>

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Print</a>
                            </li>

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Export Pdf</a>
                            </li>

                            <li role="menuitem" *ngIf="!isMobileScreen">
                                <a class="dropdown-item cp" href="javascript:void(0)">Generate E-way Bill</a>
                            </li>

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Create Credit Note</a>
                            </li>

                            <li role="menuitem">
                                <a class="dropdown-item cp" href="javascript:void(0)">Delete</a>
                            </li>

                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </form>


    <div class="table-responsive">
        <table class="table basic giddh-table table-bordered on-mobile-view">

            <thead class="thead-background1">
                <tr>

                    <!-- <th width="4%" *ngIf="selectedItems.length > 0">
                        <div class="check-image d-flex justify-content-center">
                            <img src="assets/images/unchecked.png" *ngIf="!allItemsSelected"
                                (click)="toggleAllItems(true)">
                            <img src="assets/images/checked.png" *ngIf="allItemsSelected"
                                (click)="toggleAllItems(false)">
                        </div>
                    </th> -->

                    <th width="4%">
                        <div class="check-image d-flex justify-content-center">
                            #
                        </div>
                    </th>

                    <th width="20%" class="td-search-box" #searchInvoiceContainer
                        (clickOutside)="clickedOutside($event, searchInvoiceContainer, 'invoiceNumber')">

                        <div [hidden]="showInvoiceNumberSearch">
                            <span> Invoice Number</span>
                            <i class="icon-search"
                                (click)="showInvoiceNumberSearch = true;showCustomerNameSearch = false;"></i>
                        </div>

                        <div class="input-container" [hidden]="!showInvoiceNumberSearch">
                            <input type="text" placeholder="Search Invoice No." class="w100"
                                [formControl]="invoiceNumberInput" #invoiceSearch />
                            <!--<i class="icon-search" (click)="showInvoiceNumberSearch = false;"></i>-->
                        </div>

                    </th>

                    <th width="20%" class="td-search-box" #searchCustomerContainer
                        (clickOutside)="clickedOutside($event, searchCustomerContainer, 'customerName')">

                        <ng-container *ngTemplateOutlet="searchTemplate;context:{ $implicit: showCustomerNameSearch, title: 'Customer Name', fieldName: 'customerName',
            formControl: customerNameInput}"></ng-container>

                    </th>

                    <th>
                        <div class="d-flex">
                            <div class="">Interval</div>

                            <div class="icon-pointer">
                                <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'duration'}">
                                </ng-container>

                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex">
                            <div class=""> Last Invoice Date</div>
                            <div class="icon-pointer">
                                <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'lastinvoicedate'}">
                                </ng-container>
                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex">
                            <div class=""> Next Invoice Date</div>
                            <div class="icon-pointer">
                                <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'nextcrondate'}">
                                </ng-container>


                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex">
                            <div class="">Status</div>
                            <div class="icon-pointer">
                                <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'status'}">
                                </ng-container>



                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex text-right">
                            <div class="flex-fill">Invoice Amt</div>
                            <div class="icon-pointer">
                                <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'vouchertotal'}">
                                </ng-container>


                            </div>
                        </div>
                    </th>
                </tr>
            </thead>



            <tbody *ngIf="!isLoading && (recurringData$ | async)?.totalItems > 0"
                (clickOutside)="hoveredItemForAction = ''; clickedHoveredItemForAction = ''"
                (mouseleave)="hoveredItemForAction = ''; clickedHoveredItemForAction = ''">

                <tr *ngFor="let col of recurringVoucherDetails;let i = index"
                    (mouseover)="hoveredItemForAction = col.uniqueName">

                    <!-- <td *ngIf="hoveredItemForAction === col.uniqueName || col.isSelected || selectedItems.length > 0"
                        data-title="#">
                        <div class="check-image d-flex justify-content-center">
                            <img *ngIf="!col?.isSelected" src="assets/images/unchecked.png"
                                (click)="toggleItem(col, true)" />
                            <img *ngIf="col?.isSelected" src="assets/images/checked.png"
                                (click)="toggleItem(col, false)" />
                        </div>
                    </td> -->

                    <td width="4%" data-title="#">
                        <div class="justify-content-sm d-flex justify-content-center">{{ i + 1}}</div>
                    </td>

                    <td width="20%" data-title="Invoice Number">
                        <a *ngIf="!isMobileScreen" class="cp btn-link-2"
                            (click)="col.status !== 'inactive' && openUpdatePanel(col)">{{ col.voucherNumber || '-'  }}</a>
                        <a *ngIf="isMobileScreen" class="cp btn-link-2">{{ col.voucherNumber || '-'  }}</a>
                    </td>
                    <td width="20%" data-title="Customer Name">{{ col.customerName || '-' }}</td>
                    <td data-title="Interval">{{ col.duration || '-'  }}</td>
                    <td data-title="Last Invoice Date">{{ col.lastInvoiceDate || '-'  }}</td>
                    <td data-title="Next Invoice Date ">{{ col.nextCronDate || '-'  }}</td>
                    <td data-title="Status">{{ col.status || '-' | titlecase  }}</td>
                    <td data-title="Invoice Amt" class=" text-right">
                        <!-- {{ col.voucherTotal | giddhCurrency   }} -->
                        <span class="d-inline-flex">
                            <amount-field [amount]="col.voucherTotal"
                                [currencySymbol]="false"
                                [currencyCode]="false">
                            </amount-field>
                        </span>
                    </td>
                </tr>
            </tbody>
            <tbody *ngIf="isLoading">
                <tr>
                    <td colspan="8">
                        <giddh-page-loader></giddh-page-loader>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-wrapper" *ngIf="(recurringData$ | async)?.totalItems > 20" [hidden]="isLoading">
        <div class="text-center">
            <pagination [maxSize]="5" [totalItems]="(recurringData$ | async)?.totalItems" [itemsPerPage]="20"
                (pageChanged)="pageChanged($event)" class="pagination-sm" [boundaryLinks]="true" [rotate]="false">
            </pagination>
        </div>
    </div>

    <div class="no-data mr-t2" *ngIf="(recurringData$ | async)?.totalItems === 0">
        <h1>No Recurring Vouchers Found!</h1>
    </div>
</div>

<div class="aside-overlay" *ngIf="asideMenuStateForRecurringEntry === 'in'"></div>
<app-aside-recurring-entry *ngIf="asideMenuStateForRecurringEntry === 'in'" [invoice]="selectedInvoice" [class]="asideMenuStateForRecurringEntry"
    [@slideInOut]="asideMenuStateForRecurringEntry" [mode]="'update'" [isCompany]="isCompany"
    (closeAsideEvent)="toggleRecurringAsidePane('out')">
</app-aside-recurring-entry>

<!-- region search template -->
<ng-template #searchTemplate let-show let-title="title" let-fieldName="fieldName" let-formControl="formControl">

    <div [hidden]="show">
        <span> {{ title }}</span>
        <i class="icon-search" (click)="toggleSearch(fieldName, searchBox);"></i>
    </div>

    <div class="input-container" [hidden]="!show">
        <input type="text" placeholder="Search {{ title }}" class="w100" #searchBox [formControl]="formControl" />
    </div>

</ng-template>
<!-- endregion -->

<!-- region sort icon template -->
<ng-template #sortTemplate let-column="column">

    <div class="icon-sort-asc " *ngIf="filter.sortBy !== column" (click)="sortButtonClicked('asc', column)"
        [ngClass]="{'active-text-color': filter.sortBy === column && filter.sort === 'asc'}"></div>

    <div class="icon-sort-asc " *ngIf="filter.sortBy === column && filter.sort === 'asc'"
        (click)="sortButtonClicked('desc', column)"
        [ngClass]="{'active-text-color': filter.sortBy === column && filter.sort === 'asc'}"></div>

    <div class="icon-sort-dsc " *ngIf="filter.sortBy === column && filter.sort === 'desc'"
        (click)="sortButtonClicked('asc', column)"
        [ngClass]="{'active-text-color': filter.sortBy === column && filter.sort === 'desc'}"></div>

</ng-template>
<!-- endregion -->
