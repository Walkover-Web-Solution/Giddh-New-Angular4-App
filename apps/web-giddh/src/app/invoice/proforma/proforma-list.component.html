<div class="proforma-container">

    <div class="d-flex date-advance-search">
        <form #invoiceForm="ngForm" novalidate class="form-inline input-grp-date-range-picker position-relative">
            <div class="d-flex">
                <div class="form-group mr-r1 d-flex">
                    <div class=" input-group custom-datepicker" (click)="showGiddhDatepicker($event)">
                        <i class="icon-calender calendar-addon"></i>
                        <input type="text" name="selectedDateRange" [value]="(selectedDateRangeUi) ? selectedDateRangeUi : ''" class="giddh-datepicker date-range-picker border-radius-2"/>
                    </div>
                    <div class="advance-icon cursor-pointer">
                        <span class="icon-advance-filter" (click)="toggleAdvanceSearchPopup()"
                            tooltip="Advance Search"></span>
                        <!-- -->
                    </div>
                    <div class="search-icon-block" (click)="openModal(template)">
                        <i class="icon-search"></i>
                    </div>
                </div>


            </div>
        </form>

        <!-- need to add functionality -->
        <div class="clear-filter" *ngIf="showResetAdvanceSearchIcon" (click)="resetAdvanceSearch()">
            <button class="btn btn-filter mr-0">
                <span class="icon-cross"></span> Clear Filter
            </button>
        </div>

        <div class="d-flex btn-wrapper">
            <!-- select app proforma -->
            <div class="select-all-proformas-on-mobile-view mt-1 mr-r15" *ngIf="selectedItems.length > 0">
                <div class="checkbox-img mr-1">
                    <img src="assets/images/unchecked.png" *ngIf="!allItemsSelected" (click)="toggleAllItems(true)">
                    <img src="assets/images/checked.png" *ngIf="allItemsSelected" (click)="toggleAllItems(false)">
                </div>
                Select All
            </div>
            <!--  -->
            <!-- region more items -->
            <div *ngIf="selectedItems.length === 1" class="btn-wrapper-more">

                <div *ngIf="!isCompany" class="btn-group d-inline-block mr-b1" dropdown #dp="bs-dropdown">

                    <button dropdownToggle type="button" class="btn more-btn-dropdown dropdown-toggle"
                        aria-controls="dropdown-basic">
                        More
                        <span class="caret"></span>
                    </button>

                    <ul *dropdownMenu class="dropdown-menu" role="menu" aria-labelledby="button-basic">

                        <li role="menuitem">
                            <a class="dropdown-item cp" href="javascript:void(0)"
                                (click)="toggleConfirmationModel(true)">Delete</a>
                        </li>

                    </ul>

                </div>
            </div>
            <!-- endregion -->
            <div *ngIf="voucherType === 'proformas'" class="btn-wrapper">
                <button *ngIf="!isCompany" class="btn btn-sky-blue m-0" (click)="goToInvoice('proformas')">+ New
                    Proforma
                </button>
            </div>

            <div *ngIf="voucherType === 'estimates'" class="btn-wrapper">
                <button *ngIf="!isCompany" class="btn btn-sky-blue m-0" (click)="goToInvoice('estimates')">+ New
                    Estimate
                </button>
            </div>

        </div>
    </div>

    <div class="mobile-search mr-b1" >
        <div class="row">
            <div class="col-sm-6 col-xs-6 full-width-on-mobile">
                <div class="input-container">
                    <input type="text"
                        placeholder="{{voucherType === 'proformas' ? 'Serach Proforma #' : 'Search Estimate #'}}"
                        class=" form-control" #searchBox [formControl]="voucherNumberInput" />
                </div>
            </div>
            <div class="col-sm-6 col-xs-6 full-width-on-mobile">
                <div class="input-container">
                    <input type="text" placeholder="Search Customer Name" class=" form-control" #searchBox
                        name="customerNameInput" [formControl]="customerNameInput" />
                </div>
            </div>
        </div>
        <div class="d-flex mt-1">
            <div *ngIf="voucherType === 'proformas'" class="btn-wrapper mr-r15">
                <button *ngIf="!isCompany" class="btn btn-sky-blue m-0" (click)="goToInvoice('proformas')">+ New
                    Proforma
                </button>
            </div>

            <div *ngIf="voucherType === 'estimates'" class="btn-wrapper mr-r15">
                <button *ngIf="!isCompany" class="btn btn-sky-blue m-0" (click)="goToInvoice('estimates')">+ New
                    Estimate
                </button>
            </div>
            <div *ngIf="selectedItems.length === 1" class="btn-wrapper-more">
                <div *ngIf="!isCompany" class="btn-group mr-b1 d-inline-block" dropdown #dp="bs-dropdown">

                    <button dropdownToggle type="button" class="btn more-btn-dropdown dropdown-toggle"
                        aria-controls="dropdown-basic">
                        More
                        <span class="caret"></span>
                    </button>

                    <ul *dropdownMenu class="dropdown-menu" role="menu" aria-labelledby="button-basic">

                        <li role="menuitem">
                            <a class="dropdown-item cp" href="javascript:void(0)"
                                (click)="toggleConfirmationModel(true)">Delete</a>
                        </li>

                    </ul>

                </div>

            </div>
        </div>

    </div>

    <ng-template #template>
        <div class="modal-header">
            <h4 class="modal-title bg pull-left">Search here...</h4>
            <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-sm-6 col-xs-6 full-width-on-mobile">
                    <div class="input-container">
                        <input type="text" placeholder="Search Invoice No." class=" form-control" #searchBox
                            name="voucherNumberInput" [formControl]="voucherNumberInput" />
                    </div>
                </div>
                <!-- <div class="col-sm-6 col-xs-6 full-width-on-mobile">
                    <div class="input-container">
                        <input type="text" placeholder="Search Customer Name" class=" form-control" #searchBox
                            name="accountUniqueNameInput" [formControl]="accountUniqueNameInput" />
                    </div>
                </div> -->
                <div class="col-sm-6 col-xs-6 mt-2 mt-md-0">
                    <button class="btn btn-sky-blue">Submit</button>
                </div>

            </div>

        </div>
    </ng-template>
    <!-- select app proforma -->
    <div class="clearfix">
        <div class="table-responsive remove-responsive invoice-preview">
            <table class="table basic table-bordered mr-t15 invoice-table on-mobile-view">
                <thead class="thead-background1">
                    <tr>

                        <th *ngIf="selectedItems.length > 0" width="4%" class="min-width-check">

                            <div class="check-image d-flex justify-content-center">
                                <img src="assets/images/unchecked.png" *ngIf="!allItemsSelected"
                                    (click)="toggleAllItems(true)">
                                <img src="assets/images/checked.png" *ngIf="allItemsSelected"
                                    (click)="toggleAllItems(false)">
                            </div>

                        </th>

                        <th *ngIf="selectedItems.length === 0" width="4%" class="min-width-check">
                            <div class="check-image d-flex justify-content-center">
                                #
                            </div>
                        </th>

                        <th width="13%" class="td-search-box" #searchVoucherNumberContainer
                            (clickOutside)="clickedOutside($event, searchVoucherNumberContainer, 'voucherNumber')">

                            <ng-container *ngTemplateOutlet="searchTemplate;context:{ $implicit: showVoucherNoSearch,
          title: voucherType === 'proformas' ? 'Proforma No.' : 'Estimate No.',
          fieldName: 'voucherNumber',
           formControl: voucherNumberInput}"></ng-container>

                        </th>

                        <th width="19%" class="td-search-box" #searchCustomerContainer
                            (clickOutside)="clickedOutside($event, searchCustomerContainer, 'customerName')">

                            <ng-container *ngTemplateOutlet="searchTemplate;context:{ $implicit: showCustomerSearch, title: 'Customer', fieldName: 'customerName',
           formControl: customerNameInput}"></ng-container>

                        </th>

                        <th width="10%">
                            <div class="d-flex">
                                <div class="">{{ voucherType === 'proformas' ? 'Proforma' : 'Estimate' }} Date</div>
                                <div class="icon-pointer">
                                    <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'proformaDate'}">
                                    </ng-container>
                                </div>
                            </div>
                        </th>

                        <th width="12%">

                            <div class="d-flex justify-content-end">
                                <div class=" text-right ">Total Amt.</div>
                                <div class="icon-pointer">
                                    <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'grandTotal'}">
                                    </ng-container>
                                </div>
                            </div>
                        </th>

                        <th width="12%">
                            <div class="d-flex">

                                <div class="">Expiry Date</div>
                                <div class="icon-pointer">
                                    <ng-container *ngTemplateOutlet="sortTemplate;context: {column: 'dueDate'}">
                                    </ng-container>
                                </div>
                            </div>
                        </th>

                        <th width="10%">
                            <div class="d-flex">
                                <div class="flex-fill">Status</div>
                            </div>
                        </th>

                        <th width="10%">
                            <div class="d-flex">
                                <div class="flex-fill">Action</div>
                            </div>
                        </th>


                    </tr>
                </thead>

                <tbody *ngIf="voucherData && voucherData.results.length > 0 && !(isGetAllInProcess$ | async)"
                    (clickOutside)="hoveredItemUniqueName = ''; clickedItemUniqueName = ''"
                    (mouseleave)="hoveredItemUniqueName = ''; clickedItemUniqueName = ''">

                    <tr *ngFor="let item of voucherData.results; let i = index"
                        (mouseover)="hoveredItemUniqueName = item.uniqueName">

                        <td class="check-image" width="4%" data-title="#"
                            *ngIf="hoveredItemUniqueName === item.uniqueName || item.isSelected || selectedItems.length > 0">
                            <div class="check-image"
                                class="d-flex checkbox-td">
                                <img *ngIf="!item.isSelected" src="assets/images/unchecked.png"
                                    (click)="toggleItem(item, true)" />
                                <img *ngIf="item.isSelected" src="assets/images/checked.png"
                                    (click)="toggleItem(item, false)" />
                            </div>
                        </td>

                        <td width="4%" *ngIf="!item.isSelected && hoveredItemUniqueName !== item.uniqueName && selectedItems.length === 0"
                            data-title="#">
                            <div class="d-flex index-no">
                                {{ i + 1}} </div>
                        </td>

                        <!-- <td data-title="Estimates No. #">
        <div style="position: relative" class="d-flex">
          <a href="javascript:void(0);" class="btn-link-2" (click)="onSelectInvoice(item, i)">{{item.uniqueName}}</a>
                   <img style="position: absolute;right: 0px;top: 5px;" class="cp mb-2" src="assets/icon/vol.svg"
                        tooltip="Invoice sent" placement="left"/>
        </div>
      </td> -->


                        <td width="13%" attr.data-title="{{voucherType === 'proformas' ? 'Proforma No.' : 'Estimates No.'}} ">
                            <div style="position: relative" class="d-flex">
                                <a href="javascript:void(0);" class="btn-link-2"
                                    (click)="onSelectInvoice(item)">{{item.uniqueName}}</a>
                                <!--          <img style="position: absolute;right: 0px;top: 5px;" class="cp mb-2" src="assets/icon/vol.svg"-->
                                <!--               tooltip="Invoice sent" placement="left"/>-->
                            </div>
                            <span *ngIf="item.expiredDays !== null">
                                <small class="text-danger" *ngIf="item.expiredDays === 0">
                                    Expired by Today
                                </small>
                            </span>

                        </td>

                        <td width="19%" (dblclick)="selectedCustomerUniqueName = item.uniqueName" class="cp no-dbl-click-select"
                            (clickOutside)="selectedCustomerUniqueName = ''" data-title="Customer">
                            {{item.customerName}}
                            <div *ngIf="selectedCustomerUniqueName === item.uniqueName" account-detail-modal-component
                                [accountUniqueName]="item.customerUniqueName" [from]="this.advanceSearchFilter.from"
                                [to]="this.advanceSearchFilter.to"
                                [isModalOpen]="selectedCustomerUniqueName === item.uniqueName">
                            </div>
                        </td>

                        <td width="10%" attr.data-title="{{ voucherType === 'proformas' ? 'Proforma' : 'Estimate' }} Date">
                            {{item.invoiceDate}}
                        </td>
                        <!-- <td class="text-right" data-title="Total Amt.">{{item.grandTotal | giddhCurrency}}</td> -->
                        <td width="12%" class="text-right"
                            [tooltip]="(voucherType === 'proformas' || voucherType === 'estimates') ? grandTotalPopupTemplate : ''"
                            container="body" containerClass="invoice-preview">
                                <span class="d-flex justify-content-end">

                                    <amount-field [amount]="item.amount?.amountForAccount"
                                        [currencySymbol]="item?.amount?.currencyForAccount?.symbol"
                                        [currencyCode]="item?.amount?.currencyForAccount?.code">
                                    </amount-field>
                            </span>
                        </td>
                        <ng-template #grandTotalPopupTemplate><span [innerHTML]="item.grandTotalTooltipText"></span>
                        </ng-template>
                        <td width="12%" data-title="Expiry Date">{{item.expiryDate}}</td>
                        <td data-title="Status">{{ item.status }}</td>

                        <!--for not cancelled status-->

                        <td width="10%" data-title="Action" (click)="clickedItemUniqueName = item.uniqueName" class="cp"
                            *ngIf="item.action !== 'invoiced'">



                            <div class="d-flex align-items-center">
                                <div class="flex-fill select-action">
                                    <span
                                        [ngClass]="{'text-light-2': !item.action}">{{ item.action ? item.action : 'Select Action' }}</span>
                                </div>

                                <!-- dropdown -->

                                <div *ngIf="!isCompany" class="btn-group icon-ellipse select-action" dropdown #dropdown="bs-dropdown"
                                    container="body">
                                    <a href="javascript:void(0)" id="button-basic" dropdownToggle
                                        class="dropdown-toggle icon-dots-three-vertical pull-right"
                                        aria-controls="dropdown-basic">
                                    </a>

                                    <div id="dropdown-basic" *dropdownMenu
                                        class="dropdown-menu dropdown-menu-right wd00" role="menu"
                                        aria-labelledby="edit-model-basic">
                                        <ul role="menu" class="select-action-dropdown" aria-labelledby="button-basic">
                                            <li (click)="updateVoucherAction('Accepted', item)">
                                                <a class="cp" href="javascript:void(0)">Accepted</a>
                                            </li>
                                            <li (click)="updateVoucherAction('Decline', item)">
                                                <a class="cp" href="javascript:void(0)">Declined</a>
                                            </li>
                                            <li (click)="updateVoucherAction('ConvertToSalesOrder', item)"
                                                *ngIf="voucherType === 'estimate' || voucherType === 'estimates'">
                                                <a class="cp" href="javascript:void(0)">Convert to Proforma</a>
                                            </li>
                                            <li (click)="updateVoucherAction('ConvertToInvoice', item)">
                                                <a class="cp" href="javascript:void(0)">Convert to Invoice</a>
                                            </li>
                                            <li (click)="updateVoucherAction('Expired', item)">
                                                <a class="cp" href="javascript:void(0)">Expired</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>



                                <!-- <div *ngIf="hoveredItemUniqueName === item.uniqueName || clickedItemUniqueName === item.uniqueName">
                <div dropdown #dropdown="bs-dropdown" container="body" [autoClose]="false"
                  class="icon-ellipse select-action">
                  <a id="edit-model-basic" dropdownToggle class="dropdown-toggle icon-dots-three-vertical pull-right"
                    aria-controls="dropdown-basic"></a>

                  <div id="dropdown-basic" *dropdownMenu class="dropdown-menu dropdown-menu-right wd00" role="menu"
                    aria-labelledby="edit-model-basic">
                    <ul class="select-action-dropdown">

                      <li (click)="updateVoucherAction('Accepted', item)">
                        <a class="cp" href="javascript:void(0)">Accepted</a>
                      </li>

                      <li (click)="updateVoucherAction('Decline', item)">
                        <a class="cp" href="javascript:void(0)">Declined</a>
                      </li>

                      <li (click)="updateVoucherAction('ConvertToSalesOrder', item)"
                        *ngIf="voucherType === 'estimate' || voucherType === 'estimates'">
                        <a class="cp" href="javascript:void(0)">Convert to Proforma</a>
                      </li>

                      <li (click)="updateVoucherAction('ConvertToInvoice', item)">
                        <a class="cp" href="javascript:void(0)">Convert to Invoice</a>
                      </li>
                      <li (click)="updateVoucherAction('Expired', item)">
                        <a class="cp" href="javascript:void(0)">Expired</a>
                      </li>

                    </ul>

                  </div>
                </div>
              </div> -->




                            </div>

                        </td>

                        <!--for cancelled/ declined status-->
                        <td width="10%" *ngIf="item.action === 'invoiced'" data-title="Action">
                            <span>{{ item.action}}</span>
                        </td>

                    </tr>
                </tbody>

                <tfoot *ngIf="voucherData && voucherData?.totalItems > 20" [hidden]="(isGetAllInProcess$ | async)">
                    <tr>
                        <td colspan="100%">
                            <div class="text-center">

                                <pagination [totalItems]="voucherData.totalItems" [(ngModel)]="voucherData.page"
                                    [maxSize]="5" class="pagination-sm" [boundaryLinks]="true" [itemsPerPage]="20"
                                    [rotate]="false" previousText="&#9668;" nextText="&#9658;"
                                    (pageChanged)="pageChanged($event)"></pagination>
                            </div>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>


        <!--No Entry-->
        <div class="no-data mr-t2" *ngIf="!voucherData && !(isGetAllInProcess$ | async)">
            <h1>No Entry found in sales!</h1>
            <h1>Have to do some sales before creating invoice</h1>
        </div>

        <!--no data-->
        <div class="no-data" *ngIf="voucherData && voucherData.results.length === 0 && !(isGetAllInProcess$ | async)">
            <h1>No entries found within given criteria.</h1>
            <h1>Do search with some other dates</h1>
        </div>

        <!--loading-->
        <giddh-page-loader *ngIf="(isGetAllInProcess$ | async)"></giddh-page-loader>
    </div>

    <!-- region search template -->
    <ng-template #searchTemplate let-show let-title="title" let-fieldName="fieldName" let-formControl="formControl">

        <div [hidden]="show">
            <span> {{ title }}</span>
            <i class="icon-search" (click)="toggleSearch(fieldName, searchBox);"></i>
        </div>

        <div class="input-container" [hidden]="!show">
            <input type="text" placeholder="Search {{ title }}" class="w100" #searchBox [formControl]="formControl" />
        </div>

    </ng-template>
    <!-- endregion -->

    <!-- region sort icon template -->
    <ng-template #sortTemplate let-column="column">

        <div class="icon-sort-asc" *ngIf="advanceSearchFilter.sortBy !== column"
            (click)="sortButtonClicked('asc', column)"
            [ngClass]="{'active-text-color': advanceSearchFilter.sortBy === column && advanceSearchFilter.sort === 'asc'}">
        </div>

        <div class="icon-sort-asc" *ngIf="advanceSearchFilter.sortBy === column && advanceSearchFilter.sort === 'asc'"
            (click)="sortButtonClicked('desc', column)"
            [ngClass]="{'active-text-color': advanceSearchFilter.sortBy === column && advanceSearchFilter.sort === 'asc'}">
        </div>

        <div class="icon-sort-dsc" *ngIf="advanceSearchFilter.sortBy === column && advanceSearchFilter.sort === 'desc'"
            (click)="sortButtonClicked('asc', column)"
            [ngClass]="{'active-text-color': advanceSearchFilter.sortBy === column && advanceSearchFilter.sort === 'desc'}">
        </div>

    </ng-template>
    <!-- endregion -->

    <!-- region invoice-preview-details -->
    <div *ngIf="selectedVoucher">
        <invoice-preview-details-component [(selectedItem)]="selectedVoucher" [items]="itemsListForDetails" [isCompany]="isCompany"
            [voucherType]="selectedVoucher.voucherType" [invoiceSetting]="invoiceSetting" [invoiceSearch]="invoiceSearch"
            [voucherNoForDetail]="voucherNoForDetail" [voucherDetailAction]="voucherDetailAction" (invoiceSearchEvent)="invoiceSearch = $event;"
            (closeEvent)="invoicePreviewClosed()" [appSideMenubarIsOpen]="appSideMenubarIsOpen"
            (deleteVoucher)="deleteVoucher()" (sendEmail)="sendEmail($event)" (refreshDataAfterVoucherUpdate)="getAll()"
            (updateVoucherAction)="updateVoucherAction($event)"></invoice-preview-details-component>
    </div>
    <!-- endregion -->

    <!--advance_search Modal-->
    <div bsModal #advanceSearch="bs-modal" class="modal fade" role="dialog" [config]="modalConfig" tabindex="-1">
        <div class="modal-dialog" *ngIf="showAdvanceSearchModal">
            <div class="modal-content">
                <invoice-advance-search-component [type]="'proforma'" [request]="advanceSearchFilter"
                    (applyFilterEvent)="applyAdvanceSearch($event)" (closeModelEvent)="toggleAdvanceSearchPopup()">
                </invoice-advance-search-component>
            </div>
        </div>

    </div>

    <!-- Delete Proforma/Estimate confirmation model -->
    <div bsModal #deleteConfirmationModel="bs-modal" class="modal fade" role="dialog" [config]="{keyboard:true}"
        tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <delete-role-confirmation-model [module]="voucherType+'list'" (confirmDeleteEvent)="deleteVoucher()"
                    (closeModelEvent)="toggleConfirmationModel()">
                </delete-role-confirmation-model>
            </div>
        </div>
    </div>
    <ng-template #datepickerTemplate>
        <div class="datepicker-modal">
            <div class="modal-body">
                <app-datepicker-wrapper [inputStartDate]="selectedDateRange?.startDate" [inputEndDate]="selectedDateRange?.endDate" [alwaysShowCalendars]="true" [ranges]="datePickerOption" [selectedRangeLabel]="selectedRangeLabel" [showCustomRangeLabel]="true" [showClearButton]="false"
                                        [showCancel]="true" [linkedCalendars]="true" [showDropdowns]="true" [locale]="{applyLabel: 'Done'}" (rangeClicked)="dateSelectedCallback($event)" (datesUpdated)="dateSelectedCallback($event)" [keepCalendarOpeningWithRange]="false" [showRangeLabelOnInput]="false"
                                        [dateFieldPosition]="dateFieldPosition"></app-datepicker-wrapper>
            </div>
        </div>
    </ng-template>
