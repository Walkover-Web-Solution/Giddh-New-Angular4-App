<div class="invoice-modal-content">

    <!-- region invoice details -->
    <div [hidden]="showEditMode">
        <div class="">

            <!-- region sidebar -->
            <div class="col-sm-4  col-xs-12 pd0" style="z-index:200;">

                <div class="invoice-sidebarWrapper">

                    <div class="invoice-search-box">
                        <input type="text" placeholder="search" #searchElement>

                        <div class="btn-group" dropdown *ngIf="voucherType === 'sales' && !isMobileView"
                             [autoClose]="true">
                            <button id="button-basic2" dropdownToggle type="button"
                                class="btn btn-pink dropdown-toggle dropdown-btn-new" aria-controls="dropdown-basic3">
                                + New Invoice <span class="caret"></span>
                            </button>
                            <ul id="dropdown-basic3" *dropdownMenu class="dropdown-menu dropdown-width-small"
                                role="menu" aria-labelledby="button-basic2">
                                <li role="menuitem">
                                    <a class="dropdown-item" href="javascript:void(0)" (click)="goToInvoice('cash')">Cash
                                        Invoice</a>
                                </li>
                                <li role="menuitem">
                                    <a class="dropdown-item" href="javascript:void(0)" (click)="goToInvoice('sales')">Sales
                                        Invoice</a>
                                </li>
                            </ul>
                        </div>

                        <button class="btn btn-pink" *ngIf="voucherType !== 'sales' && !isMobileView"
                                (click)="goToInvoice()">+ New
                            {{voucherType | voucherTypeToNamePipe}}</button>
                    </div>

                    <ul class="invoice-sidebar">
                        <perfect-scrollbar>
                            <li class="singleInvoiceDetail cp" *ngFor="let item of filteredData"
                                [ngClass]="{'activeItem': item.uniqueName === selectedItem.uniqueName}"
                                (click)="selectVoucher(item)">

                                <div class="row">

                                    <div class="col-xs-7">

                                        <div class="invoice-number-date">
                                            <span class="inoviceNumber">
                                                {{item.voucherNumber ? item.voucherNumber : '-'}}
                                            </span>
                                            <span class="inoviceDate">
                                                | {{item?.voucherDate}}
                                            </span>
                                        </div>

                                        <div class="invoiceHolderName">
                                            <p> {{item?.account?.customerName || item?.account?.name}}</p>
                                        </div>

                                    </div>

                                    <div class="col-xs-5">
                                        <div class="inovice-amount pull-right">
                                            {{item?.grandTotal | giddhCurrency}}
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </perfect-scrollbar>
                    </ul>
                </div>

            </div>
            <!-- endregion -->

            <div class="col-sm-8 col-xs-12 pd0 invoice-detailWrapper" #invoiceDetailWrapper>

                <div class="scroll-half">
                    <div class="invoice-detail" #invoicedetail>

                        <div class="invoiceDetail-header">

                            <div class="clearfix">

                                <div class="col-sm-4 col-xs-12 pd0">
                                    <div class="invoice-num-holder">
                                        <h3 class="invoice-num">
                                            {{selectedItem?.voucherNumber ? selectedItem?.voucherNumber : '-'}}</h3>
                                        <p class="acc-holderName">{{selectedItem?.account.name}}</p>
                                    </div>
                                </div>

                                <div class="col-sm-8 col-xs-12 pd0">
                                    <div class="edit-change-status">

                                        <span class="close-modal cp pull-right" (click)="onCancel()">
                                            <img src="assets/images/multiply.svg"></span>

                                        <!-- region for proforma and estimates -->
                                        <div class="btn-group changeStatus-dropdown pull-right" dropdown
                                             *ngIf="only4ProformaEstimates">

                                            <label class="labeled text-capitalize">
                                                {{ selectedItem.voucherStatus }}</label>

                                            <button id="button-basic" dropdownToggle type="button"
                                                    class="btn btn-pink dropdown-toggle" aria-controls="dropdown-basic">
                                                Change Status
                                                <span class="caret"></span>
                                            </button>

                                            <ul id="dropdown-basic" *dropdownMenu class="dropdown-menu" role="menu"
                                                aria-labelledby="button-basic">
                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('accepted')"><a
                                                    class="dropdown-item">Accepted</a></li>

                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('decline')"><a
                                                    class="dropdown-item">Declined</a></li>

                                                <li (click)="updateVoucherAction.emit('ConvertToSalesOrder')"
                                                    *ngIf="voucherType === 'estimate' || voucherType === 'estimates'">
                                                    <a class="cp" href="javascript:void(0)">Convert to Proforma</a>
                                                </li>

                                                <li (click)="updateVoucherAction.emit('ConvertToInvoice')">
                                                    <a class="cp" href="javascript:void(0)">Convert to Invoice</a>
                                                </li>

                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('expired')"><a
                                                    class="dropdown-item">Expired</a></li>
                                            </ul>

                                        </div>
                                        <!-- endregion -->

                                        <!-- region for invoice -->
                                        <div class="btn-group changeStatus-dropdown pull-right" dropdown
                                             *ngIf="!only4ProformaEstimates && selectedItem?.voucherType !== 'purchase'">

                                            <label *ngIf="selectedItem.voucherStatus === 'cancel'" class="labeled">
                                                {{ selectedItem.voucherStatus }}
                                            </label>

                                            <button id="button-basic2" dropdownToggle type="button"
                                                    class="btn btn-pink dropdown-toggle" aria-controls="dropdown-basic2"
                                                    *ngIf="selectedItem.voucherStatus !== 'cancel'">Change Status <span
                                                class="caret"></span>
                                            </button>

                                            <ul id="dropdown-basic2" *dropdownMenu class="dropdown-menu" role="menu"
                                                aria-labelledby="button-basic2">
                                                <li class="cp" role="menuitem"
                                                    (click)="invokeLoadPaymentModes(); receivePaymentPopup.toggle()"><a
                                                    class="dropdown-item">Paid</a></li>
                                                <li *ngIf="voucherType === 'sales'"
                                                    (click)="openInvoiceAdvanceReceiptModal()">
                                                    <a class="cp" href="javascript:void(0)">Adjust Amount</a>
                                                </li>

                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('unpaid')"><a
                                                    class="dropdown-item">Unpaid</a></li>

                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('hold')"><a class="dropdown-item">Hold</a>
                                                </li>

                                                <li class="cp" role="menuitem"
                                                    (click)="updateVoucherAction.emit('cancel')"><a
                                                    class="dropdown-item">Cancel</a></li>
                                            </ul>

                                        </div>
                                        <!-- endregion -->

                                        <div class="edit-action-btn-grps pull-right">
                                            <span *ngIf="!isMobileView">
                                                <a href="javascript:void 0" tooltip="Edit" placement="top"
                                                    (click)="toggleEditMode()"><i class="fa fa-pencil"></i></a>
                                            </span>

                                            <span class="pos-rel" *ngIf="selectedItem?.voucherType !== 'purchase'">
                                                <a href="javascript:void 0" tooltip="Send Email" placement="top"
                                                    (click)="showEmailSendModal.toggle()"><i
                                                        class="fa fa-envelope-o"></i></a>
                                            </span>

                                            <span class="pos-rel" *ngIf="selectedItem?.voucherType === 'purchase'">
                                                <a href="javascript:;" tooltip="Send Email" placement="top"
                                                    (click)="openSendMailModal(sendEmailModal)"><i
                                                        class="fa fa-envelope-o"></i></a>
                                            </span>

                                            <span *ngIf="shouldShowPrintDocument"
                                                  [ngClass]="{ 'disabled': isVoucherDownloading || isVoucherDownloadError || isFileUploading}">
                                                <a href="javascript:void 0" tooltip="Print" placement="top"
                                                    (click)="printVoucher()"><i class="fa fa-print"></i></a>
                                            </span>

                                            <span *ngIf="selectedItem.voucherType === 'purchase' && pdfPreviewLoaded">
                                                <a href="javascript:void 0" tooltip="Download" placement="top"
                                                    (click)="downloadPurchaseBillPDF()"><i class="fa fa-file-pdf-o"></i></a>
                                            </span>

                                            <span
                                                *ngIf="selectedItem?.voucherType !== 'purchase' || (selectedItem.voucherType === 'purchase' && attachedDocumentType?.type === 'pdf')"
                                                [ngClass]="{ 'disabled': isVoucherDownloading || isVoucherDownloadError || isFileUploading || shouldShowUploadAttachment}">
                                                <a href="javascript:void 0" tooltip="Download" placement="top"
                                                    (click)="downloadPdf()"><i class="fa fa-file-pdf-o"></i></a>
                                            </span>

                                            <span
                                                *ngIf="selectedItem.voucherType === 'purchase' && attachedDocumentType?.type !== 'pdf'"
                                                [ngClass]="{ 'disabled': isVoucherDownloading || isVoucherDownloadError || isFileUploading || shouldShowUploadAttachment}">
                                                <a href="javascript:void 0" tooltip="Download" placement="top"
                                                    (click)="downloadFile()"><i class="icon-download"></i></a>
                                            </span>

                                            <span>
                                                <a href="javascript:void 0" tooltip="Delete" placement="top"
                                                    (click)="deleteConfirmationModel.toggle()"><i
                                                        class="fa fa-trash"></i></a>
                                            </span>
                                        </div>
                                        <div class="history-btn">
                                            <button class="btn btn-primary" (click)="toggleActivityHistoryAsidePane()"><img
                                                    src="../../../assets/images/history-icon.svg"> History</button>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="payment-detail"
                             *ngIf="!only4ProformaEstimates && (selectedItem?.voucherType !== 'purchase')">

                            <div class="clearfix">

                                <div class="col-sm-4 pd0"
                                    *ngIf="(selectedItem.voucherType !== 'credit note' && selectedItem.voucherType !== 'debit note') &&
                                    (selectedItem.voucherStatus !== 'paid' && selectedItem.voucherStatus !== 'cancel')">
                                    <div class="single-paymentDetail clearfix pr-4">
                                        <div class="payment-icon"><img src="assets/images/dollar-icon.svg"></div>
                                        <p class="payment-content"> Receive payments in cash/check and record payments
                                            manually. </p>
                                        <a href="javascript: void 0"
                                           (click)="invokeLoadPaymentModes(); receivePaymentPopup.toggle()">Receive
                                            Payment</a>
                                    </div>
                                </div>


                                <div class="col-sm-4 pd0">
                                    <div class="single-paymentDetail clearfix">
                                        <div class="payment-icon"><img src="assets/images/send-icon.svg"></div>
                                        <p class="payment-content">You can now email this invoice to your customer or
                                            mark it as sent. </p>
                                        <a href="javascript: void 0"
                                           (click)="showEmailSendModal.show()">
                                            {{(selectedItem.voucherType === 'credit note') || (selectedItem.voucherType === 'debit note') ? 'Send Note' : 'Send Invoice'}}
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="payment-log" *ngIf="only4ProformaEstimates">
                            <div class="payment-log-div">

                                <div style="padding: 10px 0 10px 10px;" *ngIf="moreLogsDisplayed">
                                    <a href="javascript:void 0" (click)="filterVoucherVersions(false)">Less Details</a>
                                </div>
                                <div style="padding: 10px 0 10px 10px;"
                                     *ngIf="filteredVoucherVersions.length && !moreLogsDisplayed">
                                    <a href="javascript:void 0" (click)="filterVoucherVersions(true)">More Details</a>
                                </div>

                                <ul>
                                    <li *ngFor="let log of filteredVoucherVersions">
                                        <span class="small-circle"></span>
                                        <span class="aboutPaymentLog">{{ log.estimateDate }},
                                            <span *ngIf="voucherType==='estimates'">estimate</span>
                                        <span *ngIf="voucherType!=='estimates'">{{voucherType}}</span> {{ log.action }}
                                            for {{ log.grandTotal }} by {{ log.user.name }}</span>
                                    </li>
                                </ul>


                            </div>
                        </div>
                        <div class="linked-purchase-order font-14 mt-15" *ngIf="selectedItem?.voucherType === 'purchase' && purchaseOrderNumbers && purchaseOrderNumbers.length > 0">
                            <p class="mt-1 mb-1"><span class="icon-file-path"></span> Linked Purchase Order(s):</p>
                            <div class="purchase-order-number">
                                <a href="javascript:;" class="aqua-color" (click)="openPurchaseOrderPreviewPopup(purchaseOrderPreviewModal, order.uniqueName)" *ngFor="let order of purchaseOrderNumbers; let i = index;">{{order.number}}<span *ngIf="checkIfPipeSymbolRequired(i)">|</span></a>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="!isMobileView" class="invoice-image-section">
                        <div class="relative">
                            <div class="pos-rel" *ngIf="isVoucherDownloading || isFileUploading">
                                <div class="loader"></div>
                            </div>

                            <div *ngIf="isVoucherDownloadError && (!isVoucherDownloading || !isFileUploading)"
                                class="error">
                                <span>
                                    Invoice Preview is not available right now!Please try again..
                                </span>
                            </div>
                            <div class="preview-not-supported-attachment"
                                *ngIf="attachedDocumentType?.type === 'unsupported'">
                                <span class="text-warning">Supported format for preview: Images (.jpg, .jpeg, .png) and PDF (.pdf); to print other formats, download them. </span>
                            </div>

                            <div *ngIf="!shouldShowUploadAttachment" [ngClass]="{'image-collapsed': !isAttachmentExpanded}">
                                <img *ngIf="(selectedItem.voucherType === 'purchase' && attachedDocumentType?.type === 'image')"
                                    class="image-preview" [src]="imagePreviewSource"/>
                            </div>
                            <div *ngIf="shouldShowUploadAttachment"
                                class="upload-excel max500 center-block box dashed-bdr">
                                <input type="file" id="csv-upload-input" placeholder="Upload an EXCEL or CSV file"
                                    droppable="true" class="form-control" [options]="fileUploadOptions" ngFileSelect
                                    [uploadInput]="uploadInput" (uploadOutput)="onUploadOutput($event)"/>
                                <div class="clearfix pos-rel width100">
                                    <div class="file-input-wrapper text-center">
                                        <div class="clearfix mrB2">
                                            <img src="assets/images/new/import_icon.svg"/>
                                        </div>
                                        <div class="clearfix pdR2 pdL2">
                                            <label class="clearfix text-light-2" style="font-size: 14px">Drop file to
                                                upload</label>
                                            <div class="mrT3">
                                                <label class="file-uplod-penal" for="csv-upload-input"> <span>Browse
                                                        file</span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div #attachedDocumentPreview
                                class="fixed-ng2pdfview pdf-preview"
                                [ngClass]="{'fixed-ng2pdfview-2': pagecount===2, 'fixed-ng2pdfview': pagecount===1, 'fixed-ng2pdfview-3': pagecount===3,'fixed-ng2pdfview-4': pagecount===4}">
                                <ng2-pdfjs-viewer pagemode="none"
                                                viewerId="MyUniqueID"
                                                [hidden]="isVoucherDownloading || isVoucherDownloadError || isFileUploading"
                                                [downloadFileName]="'invoice.pdf'"
                                                (onDocumentLoad)="testPagesLoaded($event);" [openFile]="false"
                                                [viewBookmark]="false" [download]="false">
                                </ng2-pdfjs-viewer>
                            </div>
                            <div class="expand-file" *ngIf="selectedItem.voucherType === 'purchase' && imagePreviewSource">
                                <a href="javascript:;" *ngIf="!isAttachmentExpanded" class="cp" (click)="isAttachmentExpanded = true;"><span><img src="assets/images/expand.svg"></span>Expand</a>
                                <a href="javascript:;" *ngIf="isAttachmentExpanded" class="cp" (click)="isAttachmentExpanded = false;"><span><img src="assets/images/expand.svg" class="collapse-icon"></span>Collapse</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- endregion -->

    <!-- region edit invoice -->
    <div *ngIf="showEditMode">

        <div class="invoice-editWrapper">

            <div class="invoice-editHeader">

                <span>
                    <p>Edit {{ selectedItem.voucherType | voucherTypeToNamePipe | titlecase }}</p>
                </span>

                <span class="close-modal cp" (click)="toggleEditMode()">
                    <img src="assets/images/multiply.svg">
                </span>

            </div>

            <div class="invoice-editBody">
                <proforma-invoice-component [accountUniqueName]="selectedItem.account.uniqueName"
                                            [selectedItem]="selectedItem"
                                            [invoiceNo]="(voucherType !== 'purchase') ? selectedItem?.voucherNumber : selectedItem?.uniqueName"
                                            [invoiceType]="voucherType" (cancelVoucherUpdate)="toggleEditMode()">
                </proforma-invoice-component>
            </div>

        </div>

    </div>
    <!-- endregion -->

</div>
<div class="aside-overlay" *ngIf="revisionHistoryAsideState === 'in'"></div>
<div *ngIf="revisionHistoryAsideState === 'in'">
    <aside-revision-history (closeAsideEvent)="toggleActivityHistoryAsidePane()" [companyUniqueName]="companyUniqueName" [purchaseBill]="selectedItem"></aside-revision-history>
</div>

<ng-template #template>
    <div class="relative header-close-btn">

        <button type="button" class="close pull-right cursor-pointer" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div *ngIf="!shouldShowUploadAttachment" #attachedDocumentPreview class="fixed-ng2pdfview pdf-preview"
            [ngClass]="{'fixed-ng2pdfview-2': pagecount===2, 'fixed-ng2pdfview': pagecount===1, 'fixed-ng2pdfview-3': pagecount===3,'fixed-ng2pdfview-4': pagecount===4}">
            <ng2-pdfjs-viewer pagemode="none"
                *ngIf="selectedItem?.voucherType !== 'purchase' || (selectedItem.voucherType === 'purchase' && attachedDocumentType?.type === 'pdf')"
                viewerId="MyUniqueID" [hidden]="isVoucherDownloading || isVoucherDownloadError || isFileUploading"
                [downloadFileName]="'invoice.pdf'" (onDocumentLoad)="testPagesLoaded($event);" [openFile]="false"
                [viewBookmark]="false" [download]="false">
            </ng2-pdfjs-viewer>
            <img *ngIf="(selectedItem.voucherType === 'purchase' && attachedDocumentType?.type === 'image')"
                class="image-preview" [src]="imagePreviewSource" />
        </div>
    </div>
</ng-template>

<!-- region send email modal-->
<div bsModal #showEmailSendModal="bs-modal" class="modal fade" role="dialog"
     [config]="{keyboard:true, ignoreBackdropClick: true}" tabindex="-1">

    <div class="modal-dialog semdMailModal">

        <div class="modal-content">

            <!--  region new email design -->
            <!--      <div class="modal-header themeBg pd2 pdL2 pdR2 clearfix" style="background-color: #525252">-->
            <!--        <h3 class="modal-title bg" id="modal-title">Send Mail </h3>-->
            <!--        <i aria-hidden="true" class="fa fa-times text-right close-modal" (click)="showEmailSendModal.toggle()"></i>-->
            <!--      </div>-->

            <!--      <div class="modal-body">-->
            <!--        <div class="form sendMailForm">-->
            <!--          <div class="row mrB1">-->
            <!--            <div class="col-sm-2">-->
            <!--              <label>Form : </label>-->
            <!--            </div>-->
            <!--            <div class="col-sm-10">-->
            <!--              <input type="text" class="form-control">-->
            <!--            </div>-->

            <!--          </div>-->
            <!--          <div class="row mrB1">-->
            <!--            <div class="col-sm-2">-->
            <!--              <label>Send To: </label>-->
            <!--            </div>-->
            <!--            <div class="col-sm-10">-->
            <!--              <input type="text" class="form-control">-->
            <!--            </div>-->

            <!--          </div>-->
            <!--          <div class="row mrB1">-->
            <!--            <div class="col-sm-2 ">-->
            <!--              <label>Subject : </label>-->
            <!--            </div>-->
            <!--            <div class="col-sm-10">-->
            <!--              <input type="text" class="form-control">-->
            <!--            </div>-->

            <!--          </div>-->
            <!--          <div class="row mrB1">-->

            <!--            <div class="col-sm-10 col-sm-offset-2">-->
            <!--              <ckeditor-->
            <!--                [(ngModel)]="ckeditorContent"-->
            <!--                [config]="{uiColor: '#E4E5E6'}"-->
            <!--                [readonly]="false"-->
            <!--                debounce="500">-->
            <!--              </ckeditor>-->
            <!--            </div>-->

            <!--          </div>-->
            <!--          <div class="row mrT2 mrB1">-->
            <!--            <div class="col-sm-10 col-sm-offset-2">-->
            <!--              <div class="btn-group" role="group" aria-label="Basic example">-->
            <!--                <button type="button" class="btn btn-success">Save</button>-->
            <!--                <button type="button" class="btn btn-danger" (click)="showEmailSendModal.toggle()">Cancel</button>-->
            <!--              </div>-->
            <!--            </div>-->
            <!--          </div>-->

            <!--        </div>-->
            <!--      </div>-->
            <!-- endregion -->

            <app-send-email-invoice-component [voucherType]="voucherType"
                                              (successEvent)="sendEmail.emit($event);showEmailSendModal.hide()"
                                              [selectedItem]='selectedItem' (cancelEvent)="showEmailSendModal.hide()">
            </app-send-email-invoice-component>

        </div>
    </div>

</div>
<!-- endregion -->

<!-- region download modal-->
<div bsModal #downloadVoucherModal="bs-modal" class="modal fade" role="dialog"
     [config]="{keyboard:true, ignoreBackdropClick: true}" tabindex="-1">

    <div class="modal-dialog semdMailModal">

        <div class="modal-content">

            <download-voucher [selectedItem]="selectedItem" (cancelEvent)="downloadVoucherModal.hide()">
            </download-voucher>

        </div>
    </div>

</div>
<!-- endregion -->

<!-- region delete confirmation model -->
<div bsModal #deleteConfirmationModel="bs-modal" class="modal fade" role="dialog" [config]="{keyboard:true}"
     tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <confirm-modal
                [body]="only4ProformaEstimates ? 'Do you want to delete the voucher(s)?' : selectedItem.voucherType === 'purchase' ? 'Do you want to delete the selected records?' : 'Do you want to delete the voucher/invoice?'"
                (cancelCallBack)="deleteConfirmationModel.toggle()"
                (successCallBack)="deleteVoucher.emit(true);deleteConfirmationModel.toggle()"></confirm-modal>
        </div>
    </div>
</div>
<!-- endregion -->

<!-- region receive payment popup -->
<div bsModal #receivePaymentPopup="bs-modal" class="modal fade" role="dialog" [config]="{keyboard:true}" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <invoice-payment-model *ngIf="receivePaymentPopup.isShown" [selectedInvoiceForPayment]="selectedItem"
                                   (closeModelEvent)="processPaymentEvent.emit($event);receivePaymentPopup.toggle()">
            </invoice-payment-model>
        </div>
    </div>
</div>
<!-- endregion -->


<ng-template #purchaseBillTemplate>
    <purchase-bill-template></purchase-bill-template>
</ng-template>

<ng-template #purchaseOrderPreviewModal>
    <purchase-order-preview-modal [purchaseOrderUniqueName]="purchaseOrderPreviewUniqueName" [purchaseOrderAccountUniqueName]="selectedItem?.account?.uniqueName" [purchaseOrderCompanyUniqueName]="companyUniqueName" (closeModelEvent)="closePurchaseOrderPreviewPopup($event)"></purchase-order-preview-modal>
</ng-template>

<ng-template #sendEmailModal>
    <purchase-send-email-modal [module]="'purchase-bill'" [sendEmailRequest]="sendEmailRequest" (closeModelEvent)="closeSendMailPopup($event)"></purchase-send-email-modal>
</ng-template>