<ng-container
    appTranslate
    [file]="'subscription'"
    (commonLocaleData)="commonLocaleData = $event"
    (localeData)="localeData = $event"
    (translationComplete)="translationComplete($event)"
>
    <hamburger-menu class="hamburger-menu"></hamburger-menu>
    <div class="subscription-container pd-15">
        <div class="button-wrapper d-flex w-100 pd-l1 justify-content-between pd-r1 pd-t1">
            <button
                *ngIf="showClearFilter"
                mat-stroked-button
                class="min160 mr-l1"
                color="primary"
                (click)="clearFilter()"
            >
                + Clear Filter
            </button>
            <div class="min160 mr-l1" *ngIf="!showClearFilter"></div>
            <button mat-stroked-button class="min160 mr-l1" color="primary" (click)="createSubscription()">
                + Add Susbcription
            </button>
        </div>
        <div *ngIf="subscriptionListInProgress$ | async">
            <giddh-page-loader></giddh-page-loader>
        </div>
        <section *ngIf="shouldShowElement && !(subscriptionListInProgress$ | async)">
            <form
                class="table-responsive"
                name="subscriptionListForm"
                [formGroup]="subscriptionListForm"
                novalidate=""
                autocomplete="off"
            >
                <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="w-100">
                    <ng-container matColumnDef="companyName">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchNameContainer
                            (clickOutside)="handleClickOutside($event, searchNameContainer, 'Name')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showName,
                                        fieldName: 'Name',
                                        formControl: subscriptionListForm.controls['companyName'],
                                        title: 'Name'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td class="subscription-td" mat-cell *matCellDef="let element" width="15%">
                            <a
                                class="cursor-pointer"
                                *ngIf="element?.companies?.length > 1"
                                (click)="getCompanyList($event, element)"
                                >{{ element?.companies?.length }}</a
                            >
                            <span *ngIf="element?.companies?.length === 1">{{ element?.companies[0]?.name }}</span>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="billingAccountName">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchBillingAccountContainer
                            (clickOutside)="
                                handleClickOutside($event, searchBillingAccountContainer, 'Billing Account')
                            "
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showBillingAccount,
                                        fieldName: 'Billing Account',
                                        formControl: subscriptionListForm.controls['billingAccountName'],
                                        title: 'Billing Account'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td class="subscription-td" mat-cell *matCellDef="let element">
                            {{ element.billingAccount?.name ? element.billingAccount?.name : "-" }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="subscriberName">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchSubscriberContainer
                            (clickOutside)="handleClickOutside($event, searchSubscriberContainer, 'Subscriber')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showSubscriber,
                                        fieldName: 'Subscriber',
                                        formControl: subscriptionListForm.controls['subscriberName'],
                                        title: 'Subscriber'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td class="subscription-td" mat-cell *matCellDef="let element">
                            {{ element.subscriber?.name ? element.subscriber?.name : "-" }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="countryName">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchCountryContainer
                            (clickOutside)="handleClickOutside($event, searchCountryContainer, 'Country')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showCountry,
                                        fieldName: 'Country',
                                        formControl: subscriptionListForm.controls['countryName'],
                                        title: 'Country'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td class="subscription-td" mat-cell *matCellDef="let element">
                            {{ element.country?.countryName ? element.country?.countryName : "-" }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="planName">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchPlanSubNameContainer
                            (clickOutside)="handleClickOutside($event, searchPlanSubNameContainer, 'Plan Sub Name')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showPlanSubName,
                                        fieldName: 'Plan Sub Name',
                                        formControl: subscriptionListForm.controls['planName'],
                                        title: 'Plan Sub Name'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td
                            mat-cell
                            *matCellDef="let element"
                            class="position-relative"
                            [matTooltip]="element?.subscriptionId"
                            [matTooltipPosition]="'above'"
                            matTooltipClass="tooltip-black"
                        >
                            {{ element.plan?.name ? element.plan?.name : "-" }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="status">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchStatusContainer
                            (clickOutside)="handleClickOutside($event, searchStatusContainer, 'Status')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showStatus,
                                        fieldName: 'Status',
                                        formControl: subscriptionListForm.controls['status'],
                                        title: 'Status'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td mat-cell *matCellDef="let element" class="position-relative">
                            <span [ngClass]="{ 'text-success': element.status === 'active' }">{{
                                element.status
                            }}</span>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="period">
                        <th
                            mat-header-cell
                            *matHeaderCellDef
                            class="td-search-box"
                            #searchDurationContainer
                            (clickOutside)="handleClickOutside($event, searchDurationContainer, 'Monthly/Yearly')"
                        >
                            <ng-container
                                *ngTemplateOutlet="
                                    searchTemplate;
                                    context: {
                                        $implicit: showMonthlyYearly,
                                        fieldName: 'Monthly/Yearly',
                                        formControl: subscriptionListForm.controls['period'],
                                        title: 'Monthly/Yearly'
                                    }
                                "
                            ></ng-container>
                        </th>
                        <td mat-cell *matCellDef="let element" class="position-relative">
                            {{ element.monthYearly ? element.monthYearly : "-" }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="renewalDate">
                        <th mat-header-cell *matHeaderCellDef>Renewal Date</th>
                        <td mat-cell *matCellDef="let element" class="position-relative word-wrap">
                            <div class="d-flex align-items-center">
                                {{ element.renewalDate }}
                                <button
                                    mat-icon-button
                                    id="edit-model-basic"
                                    class="table-menu-first-td"
                                    [matMenuTriggerFor]="editModelBasic"
                                    #trigger="matMenuTrigger"
                                >
                                    <span class="icon-dots-three-vertical"></span>
                                </button>
                            </div>
                            <mat-menu #editModelBasic="matMenu">
                                <div class="account-detail-custom-header">
                                    <button
                                        *ngIf="element?.status === 'trial' || element?.status === 'expired'"
                                        mat-menu-item
                                        (click)="changePlan(element)"
                                    >
                                        Change Plan
                                    </button>
                                    <button
                                        *ngIf="!(element?.status === 'trial' || element?.status === 'expired')"
                                        mat-menu-item
                                        (click)="buyPlan()"
                                    >
                                        Buy Plan
                                    </button>
                                    <button mat-menu-item (click)="viewSubscription(element)">View Subscription</button>
                                    <button mat-menu-item (click)="changeBilling(element)">Change Billing</button>
                                    <button mat-menu-item (click)="transferSubscription(element?.subscriptionId)">
                                        Request Transfer
                                    </button>
                                    <button mat-menu-item (click)="cancelSubscription(element?.subscriptionId)">
                                        Cancel
                                    </button>
                                    <button mat-menu-item (click)="openModalMove(element, $event)">Move</button>
                                </div>
                            </mat-menu>
                        </td>
                    </ng-container>
                    <tr
                        (clickOutside)="inlineSearch = null"
                        mat-header-row
                        *matHeaderRowDef="displayedColumns; sticky: true"
                    ></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
            </form>
            <div class="pagination-wrapper justify-content-end">
                <mat-paginator
                    (page)="handlePageChange($event)"
                    [length]="subscriptionRequestParams.totalItems"
                    [pageSize]="subscriptionRequestParams.count"
                    [showFirstLastButtons]="true"
                    [pageSizeOptions]="pageSizeOptions"
                    [hidePageSize]="false"
                    [pageIndex]="pageIndex"
                    class="mt-15"
                >
                </mat-paginator>
            </div>
        </section>
        <div class="no-data" *ngIf="!shouldShowElement && !(subscriptionListInProgress$ | async)">
            <h1>No data found</h1>
        </div>
    </div>
</ng-container>
<ng-template #searchTemplate let-show let-title="title" let-fieldName="fieldName" let-formControl="formControl">
    <div [hidden]="show">
        <i class="icon-search" (click)="toggleSearch(fieldName)"></i>
        <span> {{ title }}</span>
    </div>
    <div class="input-container" [hidden]="!show">
        <text-field
            [type]="'text'"
            [placeholder]="getSearchFieldText(fieldName)"
            [cssClass]="'form-control search-table mat-field-border'"
            [formControl]="formControl"
            [autoFocus]="show"
        ></text-field>
    </div>
</ng-template>
<!-- MoveCompany Modal -->
<ng-template #moveCompany>
    <move-company
        (moveCompany)="addOrMoveCompanyCallback($event)"
        [subscriptions]="subscriptions"
        [moveSelectedCompany]="selectedCompany"
        [localeData]="localeData"
        [commonLocaleData]="commonLocaleData"
    >
    </move-company>
</ng-template>
