<form #formDiv name="addEditStockForm" [formGroup]="addStockForm" novalidate="" autocomplete="off">
    <section class="w-100">
        <div>
            <div>
                <div class="form-header row">
                    <h3 *ngIf="!isUpdatingStockForm">Create Stock</h3>
                    <h3 *ngIf="isUpdatingStockForm">Update Stock</h3>
                </div>
                <button id="close" (click)="closeAsidePane()"><i class="icon-cross"></i></button>
                <div class="aside-pane-form">
                    <section class="form-body white-bg clearfix margin-child-label">
                        <div class="clearfix">
                            <div class="row">
                                <div class="form-group col-5 col-sm-5">
                                    <label>Under Group</label>
                                    <sh-select
                                        #groupDDList
                                        [options]="groupsData$ | async"
                                        formControlName="parentGroup"
                                        [placeholder]="'Select Group'"
                                        [multiple]="false"
                                        [ItemHeight]="33"
                                        (selected)="groupSelected($event)"
                                        [isFilterEnabled]="true"
                                        [forceClearReactive]="forceClear$ | async"
                                        [notFoundLinkText]="'+ Add New'"
                                        (noResultsClicked)="addNewGroupPane()"
                                        [notFoundLink]="false"
                                    ></sh-select>
                                </div>
                                <div class="form-group col-5 col-sm-5" *ngIf="isUpdatingStockForm">
                                    <label class="d-block">&nbsp;</label>
                                    <button
                                        type="button"
                                        class="btn btn-default"
                                        (click)="moveStock()"
                                        [disabled]="addStockForm.get('parentGroup').value === activeGroup?.uniqueName"
                                    >
                                        Move
                                    </button>
                                </div>
                            </div>

                            <div class="clearfix row">
                                <div class="form-group col-5 col-sm-5">
                                    <label>Stock Name <sup>*</sup></label>
                                    <input
                                        type="text"
                                        name="name"
                                        class="form-control"
                                        (change)="generateUniqueName()"
                                        formControlName="name"
                                        #stockName
                                    />

                                    <div class="error-msg" *ngIf="addStockForm.get('name').hasError('minlength')">
                                        Minimum 2 characters required
                                    </div>
                                </div>
                                <div class="form-group col-5 col-sm-5">
                                    <label>Stock Unit <sup>*</sup></label>
                                    <sh-select
                                        [options]="stockUnitsDropDown$ | async"
                                        formControlName="stockUnitCode"
                                        [placeholder]="'Choose a parent unit'"
                                        [multiple]="false"
                                        [ItemHeight]="33"
                                        [forceClearReactive]="forceClear$ | async"
                                        (selected)="openShowOtherDetailsSection()"
                                    ></sh-select>
                                </div>
                            </div>
                            <!-- other details -->
                            <div class="row">
                                <div class="col-12 col-sm-12">
                                    <div class="form-group toggle-btn mr-b05" (click)="toggleOtherDetails()">
                                        <label class="cp">
                                            <i
                                                class="cp collapse-icons"
                                                aria-hidden="true"
                                                [ngClass]="{
                                                    'icon-minus': showOtherDetails,
                                                    'icon-plus': !showOtherDetails
                                                }"
                                            ></i
                                            >Other Details
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <ng-container *ngIf="showOtherDetails">
                                <div class="row">
                                    <div class="form-group col-4 col-sm-4">
                                        <label>Unique Name</label>
                                        <input
                                            type="text"
                                            name="uniqueName"
                                            UniqueNameDirective
                                            textCaseChangeDirective
                                            [control]="addStockForm.get('uniqueName')"
                                            class="form-control"
                                            formControlName="uniqueName"
                                            #uniqueName
                                        />
                                    </div>

                                    <div class="form-group col-4 col-sm-4">
                                        <span class="mr-r15">
                                            <input
                                                type="radio"
                                                name="showCodeType"
                                                id="hsnCodeType"
                                                formControlName="showCodeType"
                                                value="hsn"
                                            />
                                            <label for="hsnCodeType" class="ml-1">HSN Code</label>
                                        </span>
                                        <span>
                                            <input
                                                type="radio"
                                                name="showCodeType"
                                                id="sacCodeType"
                                                formControlName="showCodeType"
                                                value="sac"
                                            />
                                            <label for="sacCodeType" class="ml-1">SAC Code</label>
                                        </span>
                                        <input
                                            type="text"
                                            class="form-control"
                                            maxlength="10"
                                            decimalDigitsDirective
                                            formControlName="hsnNumber"
                                            *ngIf="addStockForm.get('showCodeType').value === 'hsn'"
                                        />
                                        <input
                                            type="text"
                                            class="form-control"
                                            maxlength="10"
                                            formControlName="sacNumber"
                                            decimalDigitsDirective
                                            *ngIf="addStockForm.get('showCodeType').value === 'sac'"
                                        />
                                    </div>
                                    <div class="form-group col-4 col-sm-4">
                                        <label>Tax</label>

                                        <div class="btn-group btn-block" dropdown>
                                            <button
                                                dropdownToggle
                                                type="button"
                                                class="dropdown-toggle form-control text-left"
                                            >
                                                Selected ({{ taxTempArray?.length }})
                                                <span class="pull-right"><span class="caret"></span></span>
                                            </button>
                                            <ul *dropdownMenu class="dropdown-menu dropdown-menu-right" role="menu">
                                                <li
                                                    role="menuitem"
                                                    *ngFor="let tax of companyTaxesList$ | async"
                                                    [ngClass]="{ 'opacity': tax.isDisabled }"
                                                >
                                                    <a class="dropdown-item" (click)="$event.stopPropagation()"
                                                        ><input
                                                            type="checkbox"
                                                            [disabled]="tax.isDisabled"
                                                            [checked]="tax.isChecked"
                                                            (click)="selectTax($event, tax)"
                                                        />
                                                        {{ tax.name }}</a
                                                    >
                                                </li>
                                                <li *ngIf="(companyTaxesList$ | async)?.length < 1">
                                                    <a class="dropdown-item" (click)="$event.stopPropagation()"
                                                        >No Tax Found</a
                                                    >
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="form-group col-4 col-sm-4">
                                        <label>Open. Qty</label>
                                        <input
                                            type="text"
                                            name="openingQuantity"
                                            decimalDigitsDirective
                                            [DecimalPlaces]="4"
                                            (change)="calCulateRate()"
                                            class="form-control"
                                            formControlName="openingQuantity"
                                        />
                                    </div>

                                    <div class="form-group col-4 col-sm-4">
                                        <label>Amount</label>
                                        <input
                                            type="tel"
                                            name="openingAmount"
                                            (change)="calCulateRate()"
                                            decimalDigitsDirective
                                            [DecimalPlaces]="2"
                                            class="form-control"
                                            formControlName="openingAmount"
                                        />
                                    </div>

                                    <div class="form-group col-4 col-sm-4">
                                        <label>Rate</label>
                                        <input
                                            type="text"
                                            name="stockRate"
                                            formControlName="stockRate"
                                            class="form-control"
                                            placeholder="Auto calculate"
                                        />
                                    </div>
                                </div>

                                <div class="row sku-row">
                                    <!-- SKU Code -->
                                    <div class="form-group col-4 col-sm-4">
                                        <label>SKU Code</label>
                                        <input
                                            type="text"
                                            name="skuCode"
                                            class="form-control"
                                            maxlength="20"
                                            (keyup)="validateSKU($event)"
                                            formControlName="skuCode"
                                        />
                                    </div>

                                    <!-- field 1 -->
                                    <div
                                        class="form-group col-4 col-sm-4"
                                        *ngIf="customField1 || addStockForm.controls['customField1Heading'].value"
                                    >
                                        <label>
                                            <span
                                                *ngIf="
                                                    !customField1HeadingEditing &&
                                                    !addStockForm.controls['customField1Heading'].value
                                                "
                                                >Custom field 1</span
                                            >
                                            <span *ngIf="!customField1HeadingEditing">{{
                                                addStockForm.controls["customField1Heading"].value
                                            }}</span>
                                            <input
                                                type="text"
                                                placeholder="Custom field 1"
                                                class="label-input"
                                                *ngIf="customField1HeadingEditing"
                                                formControlName="customField1Heading"
                                                (blur)="customField1HeadingEditing = !customField1HeadingEditing"
                                            />

                                            <span class="pull-right">
                                                <i
                                                    *ngIf="!customField1HeadingEditing"
                                                    class="icon-edit-pencil"
                                                    (click)="customField1HeadingEditing = !customField1HeadingEditing"
                                                ></i>
                                                <i
                                                    class="icon-cross text-danger"
                                                    (click)="removeCustomField('remove', 1)"
                                                ></i>
                                            </span>
                                        </label>
                                        <input
                                            type="text"
                                            name="customField1Value"
                                            class="form-control"
                                            maxlength="30"
                                            formControlName="customField1Value"
                                        />
                                    </div>
                                    <!-- field 2 -->
                                    <div
                                        class="form-group col-4 col-sm-4"
                                        *ngIf="customField2 || addStockForm.controls['customField2Heading'].value"
                                    >
                                        <label>
                                            <span
                                                *ngIf="
                                                    !customField2HeadingEditing &&
                                                    !addStockForm.controls['customField2Heading'].value
                                                "
                                                >Custom field 2</span
                                            >
                                            <span *ngIf="!customField2HeadingEditing">{{
                                                addStockForm.controls["customField2Heading"].value
                                            }}</span>
                                            <input
                                                type="text"
                                                placeholder="Custom field 2"
                                                class="label-input"
                                                *ngIf="customField2HeadingEditing"
                                                formControlName="customField2Heading"
                                                (blur)="customField2HeadingEditing = !customField2HeadingEditing"
                                            />

                                            <span class="pull-right">
                                                <i
                                                    *ngIf="!customField2HeadingEditing"
                                                    class="icon-edit-pencil"
                                                    (click)="customField2HeadingEditing = !customField2HeadingEditing"
                                                ></i>
                                                <i
                                                    class="icon-cross text-danger"
                                                    (click)="removeCustomField('remove', 2)"
                                                ></i>
                                            </span>
                                        </label>
                                        <input
                                            type="text"
                                            name="customField2Value"
                                            class="form-control"
                                            maxlength="30"
                                            formControlName="customField2Value"
                                        />
                                    </div>
                                    <!-- field 2 end -->
                                    <div class="form-group col-4 col-sm-4">
                                        <div
                                            class="new-btn"
                                            (click)="addCustomField()"
                                            *ngIf="!customField2 || !customField1"
                                        >
                                            + Custom field
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <div class="pd-l05 pd-r05 pd-t05 row">
                            <div class="col-6 col-sm-6">
                                <div class="checkbox">
                                    <label class="" for="enablePurchase">
                                        <input
                                            type="checkbox"
                                            formControlName="enablePurchase"
                                            id="enablePurchase"
                                            name="enablePurchase"
                                            class="focusBorder"
                                            (change)="focusInPurchaseAccountField()"
                                        />Purchase Information</label
                                    >
                                </div>
                                <div class="form-group">
                                    <label class="bold-head">Account Name</label>
                                    <sh-select
                                        [options]="purchaseAccountsDropDown$ | async"
                                        #purchaseAccountUniqueName
                                        formControlName="purchaseAccountUniqueName"
                                        [placeholder]="'select purchase account'"
                                        [multiple]="false"
                                        [ItemHeight]="33"
                                        [disabled]="!addStockForm.controls['enablePurchase'].value"
                                        [forceClearReactive]="forceClear$ | async"
                                        (selected)="onSelectPurchaseAccount()"
                                    ></sh-select>
                                </div>

                                <div class="row">
                                    <div class="col-7 col-sm-7">
                                        <label>Unit</label>
                                    </div>
                                    <div class="col-4 col-sm-4 row">
                                        <label>Rate</label>
                                    </div>
                                </div>

                                <div formArrayName="purchaseUnitRates">
                                    <div
                                        *ngFor="
                                            let item of addStockForm.get('purchaseUnitRates')['controls'];
                                            let i = index;
                                            let f = first;
                                            let l = last
                                        "
                                    >
                                        <div [formGroupName]="i" class="row">
                                            <div class="form-group col-7 col-sm-7">
                                                <sh-select
                                                    [options]="stockUnitsDropDown$ | async"
                                                    #purchaseStockUnitCode
                                                    formControlName="stockUnitCode"
                                                    [multiple]="false"
                                                    [placeholder]="'Select Unit'"
                                                    [ItemHeight]="33"
                                                    [disabled]="!addStockForm.controls['enablePurchase'].value"
                                                    [forceClearReactive]="forceClear$ | async"
                                                    [notFoundLinkText]="'+ Add New'"
                                                    (noResultsClicked)="addNewStockUnit()"
                                                    [notFoundLink]="true"
                                                    (selected)="onSelectPurchaseStockUnitCode()"
                                                >
                                                </sh-select>
                                            </div>
                                            <div class="form-group row col-4 col-sm-4">
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    decimalDigitsDirective
                                                    [DecimalPlaces]="4"
                                                    formControlName="rate"
                                                    (blur)="enableSales.focus()"
                                                    #purchaseRate
                                                />
                                            </div>
                                            <div class="pull-right unit-add">
                                                <button
                                                    class="btn-link btn mr-0"
                                                    (click)="addPurchaseUnitRates(i)"
                                                    *ngIf="l"
                                                >
                                                    <i class="icon-plus add-row"></i>
                                                </button>
                                                <button
                                                    class="btn-link btn"
                                                    (click)="removePurchaseUnitRates(i)"
                                                    *ngIf="!l"
                                                >
                                                    <i class="icon-cross delete"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-6 col-sm-6">
                                <div class="checkbox">
                                    <label class="" for="enableSales">
                                        <input
                                            type="checkbox"
                                            formControlName="enableSales"
                                            id="enableSales"
                                            name="enableSales"
                                            class="focusBorder"
                                            #enableSales
                                            (change)="focusInSalesAccountField()"
                                        />Sales Information</label
                                    >
                                </div>
                                <div class="form-group">
                                    <label class="">Account Name</label>
                                    <sh-select
                                        [options]="salesAccountsDropDown$ | async"
                                        #salesAccountUniqueName
                                        formControlName="salesAccountUniqueName"
                                        [multiple]="false"
                                        [disabled]="!addStockForm.controls['enableSales'].value"
                                        [placeholder]="'select sales account'"
                                        [ItemHeight]="33"
                                        [forceClearReactive]="forceClear$ | async"
                                        (selected)="onSelectSalesAccount()"
                                    >
                                    </sh-select>
                                </div>
                                <div class="row">
                                    <div class="col-7 col-sm-7">
                                        <label>Unit</label>
                                    </div>
                                    <div class="col-4 col-sm-4 row">
                                        <label>Rate</label>
                                    </div>
                                </div>

                                <div formArrayName="saleUnitRates">
                                    <div
                                        *ngFor="
                                            let item of addStockForm.get('saleUnitRates')['controls'];
                                            let i = index;
                                            let f = first;
                                            let l = last
                                        "
                                    >
                                        <div [formGroupName]="i" class="row">
                                            <div class="form-group col-7 col-sm-7">
                                                <sh-select
                                                    [options]="stockUnitsDropDown$ | async"
                                                    #salesStockUnitCode
                                                    formControlName="stockUnitCode"
                                                    [multiple]="false"
                                                    [disabled]="!addStockForm.controls['enableSales'].value"
                                                    [placeholder]="'Select Unit'"
                                                    [ItemHeight]="33"
                                                    [forceClearReactive]="forceClear$ | async"
                                                    [notFoundLinkText]="'+ Add New'"
                                                    (noResultsClicked)="addNewStockUnit()"
                                                    [notFoundLink]="true"
                                                    (selected)="onSelectSalesStockUnitCode()"
                                                >
                                                </sh-select>
                                            </div>
                                            <div class="form-group row col-4 col-sm-4">
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    decimalDigitsDirective
                                                    [DecimalPlaces]="4"
                                                    formControlName="rate"
                                                    (blur)="isFsStock.focus()"
                                                    #salesRate
                                                />
                                            </div>
                                            <div class="pull-right unit-add">
                                                <button
                                                    class="btn-link btn mr-0"
                                                    (click)="addSaleUnitRates(i)"
                                                    *ngIf="l"
                                                >
                                                    <i class="icon-plus add-row"></i>
                                                </button>
                                                <button
                                                    class="btn-link btn mr-0"
                                                    (click)="removeSaleUnitRates(i)"
                                                    *ngIf="!l"
                                                >
                                                    <i class="icon-cross delete"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mr-t1 pd-l05 pd-r05 row">
                            <div class="col-12 col-sm-12">
                                <div class="checkbox">
                                    <label class="" for="isFsStock">
                                        <input
                                            #isFsStock
                                            type="checkbox"
                                            class="focusBorder"
                                            formControlName="isFsStock"
                                            id="isFsStock"
                                            #isFinishedStock
                                            [disabled]=""
                                            name="isFsStock"
                                            (change)="showManufacturingQuantitySection()"
                                        />
                                        Is it a finished stock? (Manufacturing/Combo)</label
                                    >
                                </div>
                            </div>
                        </div>

                        <section class="mr-t2 mr-b3 col-12 col-sm-12 row" *ngIf="addStockForm.value.isFsStock">
                            <div class="pd-l05 pd-r05">
                                <h1 class="section-head bd-rb">
                                    <strong>{{ addStockForm.controls["name"].value }} (Made with)</strong>
                                </h1>
                                <table class="no-hover width-100">
                                    <tbody formGroupName="manufacturingDetails">
                                        <tr class="output-row">
                                            <td class="form-group">
                                                <label>Output Qty <sup>*</sup></label>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    decimalDigitsDirective
                                                    [DecimalPlaces]="4"
                                                    name="manufacturingQuantity"
                                                    #manufacturingQuantity
                                                    placeholder="Quantity"
                                                    formControlName="manufacturingQuantity"
                                                />
                                            </td>
                                            <td class="form-group">
                                                <label>Stock Unit <sup>*</sup></label>
                                                <sh-select
                                                    [options]="stockUnitsDropDown$ | async"
                                                    formControlName="manufacturingUnitCode"
                                                    [placeholder]="'Select Unit'"
                                                    [multiple]="false"
                                                    [ItemHeight]="33"
                                                    [forceClearReactive]="forceClear$ | async"
                                                    (selected)="onSelectManufacturingStockUnitCode()"
                                                ></sh-select>
                                            </td>
                                            <td
                                                *ngIf="
                                                    addStockForm.controls['manufacturingDetails'].controls[
                                                        'manufacturingQuantity'
                                                    ].value
                                                "
                                                colspan="2"
                                            >
                                                <label class="d-block">&nbsp;</label>
                                                <span class="width-100"
                                                    ><strong
                                                        >= (
                                                        {{
                                                            addStockForm.controls["manufacturingDetails"].controls[
                                                                "manufacturingQuantity"
                                                            ].value
                                                        }}
                                                        {{
                                                            addStockForm.controls["manufacturingDetails"].controls[
                                                                "manufacturingUnitCode"
                                                            ].value
                                                        }}
                                                        {{ addStockForm.controls["name"].value }} )</strong
                                                    ></span
                                                >
                                            </td>
                                            <!-- <td colspan="1">&nbsp;</td> -->
                                        </tr>
                                        <tr class="no-hover table-label">
                                            <td [style.width.px]="200"><strong>Input Stock Name</strong></td>
                                            <td><strong>Stock Qty</strong></td>
                                            <td><strong>Stock Unit</strong></td>
                                            <td colspan="1"></td>
                                        </tr>

                                        <ng-container formArrayName="linkedStocks">
                                            <tr
                                                *ngFor="
                                                    let list of addStockForm.get('manufacturingDetails')['controls'][
                                                        'linkedStocks'
                                                    ].controls;
                                                    let i = index;
                                                    let l = last
                                                "
                                                [formGroupName]="i"
                                                class="fsstock"
                                            >
                                                <td>
                                                    <sh-select
                                                        [options]="stockListDropDown$ | async"
                                                        #manufacturingStockUniqueName
                                                        formControlName="stockUniqueName"
                                                        [multiple]="false"
                                                        [placeholder]="'Select Stock Name'"
                                                        [placeholder]="'Select Stock'"
                                                        [ItemHeight]="33"
                                                        (selected)="
                                                            findAddedStock($event?.value, i);
                                                            manufacturingStockQuantity.focus()
                                                        "
                                                        [forceClearReactive]="forceClearStock$ | async"
                                                    ></sh-select>
                                                </td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        formControlName="quantity"
                                                        #manufacturingStockQuantity
                                                        decimalDigitsDirective
                                                        [DecimalPlaces]="4"
                                                        name="quantity"
                                                        placeholder="Enter Quantity"
                                                        class="form-control"
                                                        (blur)="onSelectManufacturingStockQuantity()"
                                                    />
                                                </td>
                                                <td>
                                                    <sh-select
                                                        [options]="stockUnitsDropDown$ | async"
                                                        #manufacturingStockUnitCode
                                                        formControlName="stockUnitCode"
                                                        [multiple]="false"
                                                        [placeholder]="'Select Unit'"
                                                        [ItemHeight]="33"
                                                        [forceClearReactive]="forceClearStockUnit$ | async"
                                                    ></sh-select>
                                                </td>
                                                <td>
                                                    <button
                                                        class="btn-link btn mr-0"
                                                        (click)="addItemInLinkedStocks(list, i, i)"
                                                        *ngIf="l"
                                                        [disabled]="disableStockButton"
                                                    >
                                                        <i class="icon-plus add-row"></i>
                                                    </button>
                                                    <button
                                                        class="btn-link"
                                                        (click)="removeItemInLinkedStocks(i)"
                                                        *ngIf="!l"
                                                    >
                                                        <i class="icon-cross delete"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </ng-container>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <div class="col-12 col-sm-12 text-left">
                            <div class="mr-t1 pd-l05 pd-r05 row">
                                <button
                                    type="submit"
                                    *ngIf="!isUpdatingStockForm"
                                    [ladda]="isStockAddInProcess$ | async"
                                    (click)="submit()"
                                    class="btn btn-success"
                                    [disabled]="addStockForm.invalid || disableStockButton"
                                >
                                    Save
                                </button>
                                <!-- <button type="button" *ngIf="isUpdatingStockForm"
                                    [ladda]="isStockUpdateInProcess$ | async" class="btn btn-primary" (click)="update()"
                                    [disabled]="addStockForm.invalid || disableStockButton">Update
                                </button>
                                <button *ngIf="isUpdatingStockForm" [ladda]="isStockDeleteInProcess$ | async"
                                    class="btn btn-danger" (click)="deleteStock()">Delete Stock
                                </button> -->
                                <button
                                    type="button"
                                    *ngIf="!isUpdatingStockForm"
                                    (click)="resetStockForm()"
                                    class="btn btn-default"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </section>

    <div class="clearfix"></div>
    <!--manufactre details  -->

    <div class="clearfix"></div>
</form>
