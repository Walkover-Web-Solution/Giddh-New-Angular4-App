<form #invoiceForm="ngForm" (ngSubmit)="onSubmitInvoiceForm(invoiceForm)" novalidate class="clearfix mrB2">

  <div class="pdB1 bdrB">
    <h3>Sales</h3>
  </div>

  <div class="clearfix">
    <div class="clearfix pdT2 pdB2">
      <div class="col-xs-6">
        <div class="flex-row">
          <div class="flex-row-child">
            <div class="form-group noMarg size_380">
              <label>Customer Name or <a href (click)="toggleAccountAsidePane($event)">+ Add Customer</a></label>
              <input
              autocomplete="off"
              name="customerName"
              [(ngModel)]="invFormData.customerName"
              [typeahead]="accounts$ | async"
              typeaheadOptionField="name"
              placeholder="Search from accounts"
              typeaheadOptionsLimit="10"
              (typeaheadNoResults)="noResultsForCustomer($event)"
              (typeaheadOnSelect)="onSelectCustomer($event)"
              class="form-control">
            </div>
          </div>
          <div class="flex-row-child" *ngIf="typeaheadNoResultsOfCustomer">
            <div class="form-group noMarg">
              <label>Add Entry Against</label>
              <select class="form-control" name="account.uniqueName" [(ngModel)]="invFormData.account.uniqueName">
                <option [ngValue]="select">Select Bank/Cash</option>
                <option [ngValue]="bank.uniqueName" *ngFor="let bank of bankAccounts$ | async" >{{ bank.name }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xs-6 text-right">
        <p class="lead b">Balance Due: Rs.00.00</p>
      </div>
    </div>
    <div class="col-xs-12"><div class="bdrB"></div></div>
  </div>

  <section class="form-inline col-xs-12">

    <div class="collapse-pane">
      <div class="collapse-pane-heading" (click)="isGenDtlCollapsed = !isGenDtlCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isGenDtlCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">General Details</div>
      </div>
      <div [collapse]="isGenDtlCollapsed" class="clearfix pdL3 pdR3">
        <div class="form-group size_340">
          <label>Attention to</label>
          <input type="text" name="attention" class="form-control" [(ngModel)]="invFormData.account.attentionTo" />
        </div>
        <div class="form-group">
          <label>Country</label>
          <ng-select class="splSales" name="country" [options]="countrySource" [(ngModel)]="invFormData.country.countryName"></ng-select>
        </div>
        <div class="form-group">
          <label>Invoice Date</label>
          <input type="text" name="invoiceDate" class="form-control"  [(ngModel)]="invFormData.invoiceDetails.invoiceDate" />
        </div>
        <!-- <div class="form-group">
          <label>Invoice Number</label>
          <input type="text" name="invoiceNumber" class="form-control" [(ngModel)]="invFormData.invoiceDetails.invoiceNumber" />
        </div> -->
        <div class="form-group">
          <label>Due Date</label>
          <input type="text" name="dueDate" class="form-control" [(ngModel)]="invFormData.invoiceDetails.dueDate" />
        </div>

      </div>
    </div>
    <!-- end general details collapse pane -->

    <div class="collapse-pane">
      <div class="collapse-pane-heading" (click)="isMlngAddrCollapsed = !isMlngAddrCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isMlngAddrCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">Address</div>
      </div>
      <div [collapse]="isMlngAddrCollapsed" class="clearfix pdL3 pdR3">
        <div class="flex-row wid90p">
          <div class="flex-row-child">
            <div class="form-group size_340">
              <label>Billing Address</label>
              <textarea name="billingDetails.address" class="form-control" [(ngModel)]="invFormData.account.billingDetails.address[0]"></textarea>
            </div>
            <div class="form-group" *ngIf="invFormData.country.countryName === 'India'">
              <div>
                <label>State</label>
                <ng-select #statesBilling class="splSales" name="billingDetails.stateCode" [options]="statesSource$ | async" [(ngModel)]="invFormData.account.billingDetails.stateCode"></ng-select>
              </div>
              <div class="mrT27">
                <label>GSTIN</label>
                <input maxLength="15" type="text" name="billingDetails.gstNumber" class="form-control"  [(ngModel)]="invFormData.account.billingDetails.gstNumber" (keyup)="getStateCode('billingDetails', statesBilling)" />
              </div>
            </div>
          </div>
          <div class="flex-row-child">
            <div class="form-group size_340">
              <label>Shipping Address</label>
              <textarea name="shippingDetails.address" class="form-control" [(ngModel)]="invFormData.account.shippingDetails.address[0]"></textarea>
            </div>
            <div class="form-group" *ngIf="invFormData.country.countryName === 'India'">
              <div>
                <label>State</label>
                <ng-select #statesShipping class="splSales" name="shippingDetails.stateCode" [options]="statesSource$ | async" [(ngModel)]="invFormData.account.shippingDetails.stateCode"></ng-select>
              </div>
              <div class="mrT27">
                <label>GSTIN</label>
                <input maxLength="15" type="text" name="shippingDetails.gstNumber" class="form-control"  [(ngModel)]="invFormData.account.shippingDetails.gstNumber" (keyup)="getStateCode('shippingDetails', statesShipping)" />
              </div>
            </div>
          </div>
        </div>
        <!-- end row -->
      </div>
    </div>
    <!-- end mailing address collapse pane -->

    <div class="collapse-pane">
      <div class="collapse-pane-heading" (click)="isOthrDtlCollapsed = !isOthrDtlCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isOthrDtlCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">Other Details</div>
      </div>
      <div [collapse]="isOthrDtlCollapsed" class="clearfix pdL3 pdR3">
        <div class="form-group size_175">
          <label>Ship Date</label>
          <input type="text" placeholder="DD-MM-YYYY" name="shippingDate" [(ngModel)]="invFormData.other.shippingDate" class="form-control" />
        </div>
        <div class="form-group size_175">
          <label>Ship Via</label>
          <input type="text" name="shippedVia" [(ngModel)]="invFormData.other.shippedVia" class="form-control" />
        </div>
        <div class="form-group size_175">
          <label>Tracking No.</label>
          <input type="text" name="trackingNumber" [(ngModel)]="invFormData.other.trackingNumber" class="form-control" />
        </div>
        <div class="form-group size_175">
          <label>Field 1</label>
          <input type="text" name="customField1" [(ngModel)]="invFormData.other.customField1" class="form-control" />
        </div>
        <div class="form-group size_175">
          <label>Field 2</label>
          <input type="text" name="customField2" [(ngModel)]="invFormData.other.customField2" class="form-control" />
        </div>
        <div class="form-group size_175">
          <label>Field 3</label>
          <input type="text" name="customField3" [(ngModel)]="invFormData.other.customField3" class="form-control" />
        </div>
      </div>
    </div>
    <!-- end other details collapse pane -->

  </section>

  <section class="clearfix pdT2 pdB2 mrB2 whiteBg">
   <table class="table">
      <thead>
        <tr>
          <th *ngFor="let item of theadArr;" [hidden]="!item.display">{{item.label}}</th>
          <th class="nested-table-wrap">
            <table width="100%" class="nested-table" cellspacing="0" cellspadding="0">
              <thead>
                <tr>
                  <th width="25%" *ngFor="let item of theadArrOpt;">{{item.label}}</th>
                </tr>
              </thead>
            </table>
          </th>
          <th *ngFor="let item of theadArrReadOnly;" [hidden]="!item.display">{{item.label}}</th>
        </tr>
      </thead>
      <tbody *ngFor="let entry of invFormData.entries; let entryIdx = index; let first = first; let last = last">
        <tr *ngFor="let transaction of entry.transactions;">
          <td>{{ entryIdx+1 }}</td>
          <td><input type="text" placeholder="DD-MM-YYYY" name="transaction.date_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.date" /></td>
          <td>
            <div class="ng-select-wrap">
              <ng-select
                class="form-inline"
                name="transaction.fakeAccForSelect2_{{entryIdx}}"
                placeholder="Select A/c"
                filterPlaceholder="Type to search..."
                notFoundMsg="No A/c found"
                notFoundLink="true"
                [allowClear]="true"
                [(ngModel)]="transaction.fakeAccForSelect2"
                [options]="salesAccounts$ | async"
                (selected)="onSelectSalesAccount($event, transaction)"
                (noResultsClicked)="onNoResultsClicked(entryIdx)"
                >
                <ng-template #optionTemplate let-option="option">
                  <div class="account-list-item">{{option?.label}}</div>
                  <div class="account-list-item fs12">{{option?.value}}</div>
                  <div class="account-list-item fs11">
                    {{option?.additional?.stock?.name}}
                  </div>
                </ng-template>
              </ng-select>
            </div>
            <input type="text" placeholder="Description" name="transaction.description_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.description" />
          </td>
          <td>
            <div class="">
              <input type="text" [hidden]="transaction.hsnOrSac !== 'hsn'" readonly  maxLength="10" placeholder="HSN/SAC" name="transaction.hsnNumber_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.hsnNumber" />
              <input type="text" [hidden]="transaction.hsnOrSac !== 'sac'" readonly  maxLength="10" placeholder="HSN/SAC" name="transaction.sacNumber_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.sacNumber" />
            </div>
          </td>

          <!-- show/hide fields -->
          <td class="nested-table-wrap">
            <table width="100%" cellspacing="0" cellspadding="0">
              <tbody>
                <tr>
                  <td *ngIf="transaction.isStockTxn">
                    <table class="nested-table" width="100%" cellspacing="0" cellspadding="0">
                      <tbody>
                        <tr>
                          <td width="25%">
                            <input type="text" (ngModelChange)="transaction.setAmount(entry)" placeholder="Quantity" name="transaction.quantity_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.quantity" />
                          </td>
                          <td width="25%">
                            <select class="form-control" name="transaction.stockUnit_{{entryIdx}}" [(ngModel)]="transaction.stockUnit">
                              <option *ngFor="let stock of transaction.stockList" [ngValue]="stock.id">{{stock.text}}</option>
                            </select>
                          </td>
                          <td width="25%">
                            <input type="text" (ngModelChange)="transaction.setAmount(entry)" placeholder="Rate" name="transaction.rate_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.rate" />
                          </td>
                          <td width="25%"><input type="text" disabled="true" class="form-control" /></td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td *ngIf="!transaction.isStockTxn">
                    <table class="nested-table" width="100%" cellspacing="0" cellspadding="0">
                      <tbody>
                        <tr>
                          <td width="25%"><input type="text" disabled="true" class="form-control" /></td>
                          <td width="25%"><input type="text" disabled="true" class="form-control" /></td>
                          <td width="25%"><input type="text" disabled="true" class="form-control" /></td>
                          <td width="25%">
                            <input type="text" (ngModelChange)="transaction.setAmount(entry)" placeholder="Amount" name="transaction.amount_{{entryIdx}}" class="form-control" [(ngModel)]="transaction.amount" />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
          <td>
            <discount-list (selectedDiscountItems)="selectedDiscountEvent($event, transaction, entry)"></discount-list>
          </td>
          <td><input type="text" name="transaction.taxableValue_{{entryIdx}}" class="form-control" readonly [(ngModel)]="transaction.taxableValue" /></td>
          <td class="tax-list-dd-wrap" *ngIf="showTaxBox">
            <tax-control
              [taxes]="companyTaxesList$ | async"
              [applicableTaxes]="[]"
              [taxRenderData]="[]"
              [showTaxPopup]="false"
              [showHeading]="false"
              (selectedTaxEvent)="selectedTaxEvent($event, entry)"
              (taxAmountSumEvent)="taxAmountEvent($event, transaction, entry)">
            </tax-control>
          </td>
          <td><input type="text" name="transaction.total_{{entryIdx}}" class="form-control" readonly [(ngModel)]="transaction.total" /></td>
          <td class="action-panel-td">
            <span class="cp" (click)="addBlankRow(transaction)"><i class="icon-add" aria-hidden="true"></i></span>
            <span class="cp" *ngIf="!first" (click)="removeTransaction(entryIdx)"><i class="icon-cross" aria-hidden="true"></i></span>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="row">
    <section id="actionPane" class="text-center">
      <div class="col-xs-12">
        <div class="pull-right pr">
          <button type="button" (click)="resetInvoiceForm(invoiceForm)" class="btn btn-default mrR1">Clear</button>
          <button type="button" (click)="triggerSubmitInvoiceForm(invoiceForm)" class="btn btn-default mrR1">Generate Invoice &amp; Update A/c</button>
          <button type="submit" class="btn btn-default">Generate Invoice</button>
        </div>
      </div>
    </section>
  </section>
</form>

<!-- open account aside -->
<div class="aside-overlay" *ngIf="accountAsideMenuState === 'in' || asideMenuStateForProductService === 'in'"></div>
<aside-menu-account
[class]="accountAsideMenuState"
[@slideInOut]="accountAsideMenuState"
(closeAsideEvent)="toggleAccountAsidePane($event)"></aside-menu-account>

<!-- open product service aside -->
<aside-menu-product-service
  [class]="asideMenuStateForProductService"
  [@slideInOut]="asideMenuStateForProductService"
  (closeAsideEvent)="onNoResultsClicked()"
  (animatePAside)="getActionFromAside($event)"
></aside-menu-product-service>


<!-- create Group modal -->
<section *ngIf="showCreateGroupModal">
  <div bsModal #createGroupModal="bs-modal" class="modal fade" role="dialog" [config]="modalConfig">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <sales-add-group-modal (actionFired)="closeCreateGroupModal($event)"></sales-add-group-modal>
      </div>
    </div>
  </div>
</section>

<!-- create Ac modal -->
<section *ngIf="showCreateAcModal">
  <div bsModal #createAcModal="bs-modal" class="modal fade" role="dialog" [config]="modalConfig">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <create-account-modal [gType]="createAcCategory" (actionFired)="closeCreateAcModal()"></create-account-modal>
      </div>
    </div>
  </div>
</section>
