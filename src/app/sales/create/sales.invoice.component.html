<form #invoiceForm="ngForm" (ngSubmit)="onSubmitInvoiceForm(invoiceForm)" novalidate class="clearfix mrB2">

  <div class="pdB1 bdrB">
    <h3>Sales</h3>
  </div>

  <div class="clearfix">
    <div class="clearfix pdT2 pdB2">
      <div class="col-xs-6">
        <div class="flex-row">
          <div class="flex-row-child">
            <div class="form-group noMarg">
              <label>Customer Name</label>
              <sh-select
                style="width: 400px;"
                [options]="accounts$ | async"
                [(ngModel)]="invFormData.customerName"
                name="customerName"
                (noOptionsFound)="noResultsForCustomer($event)"
                (selected)="onSelectCustomer($event)"
                [placeholder]="'Select Customer'"
                [notFoundLink]="true"
                [doNotReset]="true"
                [isFilterEnabled]="true"
                (noResultsClicked)="toggleAccountAsidePane($event)"
                [multiple]="false"
                [ItemHeight]="67"
                [notFoundLinkText]="'Add Customer'"
                [useInBuiltFilterForIOptionTypeItems]="true"
                >
                <ng-template #optionTemplate let-option="option">
                  <a href="javascript:void(0)" class="list-item" style="border-bottom: 1px solid #ccc;">
                    <div class="item">{{ option.label }}</div>
                    <div class="item_unq">{{ option.value }}</div>
                  </a>
                </ng-template>
              </sh-select>
            </div>
          </div>
          <div class="flex-row-child mrL2" *ngIf="typeaheadNoResultsOfCustomer">
            <div class="form-group noMarg">
              <label>Add Entry Against</label>
              <sh-select
              style="width: 250px;"
              name="account.uniqueName"
              [options]="bankAccounts$ | async"
              [(ngModel)]="invFormData.account.uniqueName"
              (selected)="onSelectBankCash($event)"
              [placeholder]="'Select Bank A/c'"
              [notFoundLink]="false"
              [multiple]="false"
              [ItemHeight]="67"
              [useInBuiltFilterForIOptionTypeItems]="true"
              >
                <ng-template #optionTemplate let-option="option">
                  <a href="javascript:void(0)" class="list-item" style="border-bottom: 1px solid #ccc;">
                    <div class="item">{{ option.label }}</div>
                    <div class="item_unq">{{ option.value }}</div>
                  </a>
                </ng-template>
              </sh-select>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xs-6 text-right">
        <p class="fs20 b">Balance Due: Rs {{invFormData.balanceDue | number:'1.2-2'}}</p>
      </div>
    </div>
    <div class="col-xs-12">
      <div class="bdrB"></div>
    </div>
  </div>

  <section class="form-inline col-xs-12 mrB1">

    <div class="collapse-pane clearfix">
      <div class="collapse-pane-heading" (click)="isGenDtlCollapsed = !isGenDtlCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isGenDtlCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">General Details</div>
      </div>
      <div [collapse]="isGenDtlCollapsed" class="clearfix pdL3 pdR3 col-xs-11 mr0">
        <div class="row">
          <div class="form-group col-xs-4">
            <label>Attention to</label>
            <input type="text" name="attention" class="form-control" [(ngModel)]="invFormData.account.attentionTo" />
          </div>
          <div class="form-group col-xs-2">
            <label>Country</label>
            <ng-select class="splSales" name="country" [options]="countrySource" [(ngModel)]="invFormData.country.countryName"></ng-select>
          </div>
          <div class="form-group col-xs-2">
            <label>Invoice Date</label>
            <input type="text" [placeholder]="giddhDateFormat" name="invoiceDate" class="form-control" bsDatepicker
            [(ngModel)]="invFormData.invoiceDetails.invoiceDate"
            value="{{ invFormData.invoiceDetails.invoiceDate | date: giddhDateFormatUI }}">
            <!-- <input type="text" [placeholder]="giddhDateFormat" name="invoiceDate"
              class="form-control" readonly [value]="invFormData.invoiceDetails.invoiceDate | date: giddhDateFormatUI "
            /> -->
          </div>
          <div class="form-group col-xs-2">
            <label>Due Date</label>
            <input type="text" [placeholder]="giddhDateFormat" name="dueDate" class="form-control" bsDatepicker [(ngModel)]="invFormData.invoiceDetails.dueDate"
              value="{{ invFormData.invoiceDetails.dueDate | date: giddhDateFormatUI }}" />
          </div>
        </div>
      </div>
    </div>
    <!-- end general details collapse pane -->

    <div class="collapse-pane clearfix">
      <div class="collapse-pane-heading" (click)="isMlngAddrCollapsed = !isMlngAddrCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isMlngAddrCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">Address</div>
      </div>
      <div [collapse]="isMlngAddrCollapsed" class="clearfix pdL3 pdR3 col-xs-11 mr0">
        <div class="row">
          <div class="">
            <div class="col-xs-6">
              <div class="row">
                <div class="form-group" [ngClass]="{'col-xs-8':invFormData.country.countryName === 'India', 'col-xs-12': invFormData.country.countryName !== 'India' }">
                  <label>Billing Address</label>
                  <textarea name="billingDetails.address" (keyup)="autoFillShippingDetails()" class="form-control" [(ngModel)]="invFormData.account.billingDetails.address[0]"
                    rows="5"></textarea>
                </div>
                <div class="form-group col-xs-4" *ngIf="invFormData.country.countryName === 'India'">
                  <div>
                    <label>State</label>
                    <ng-select (selected)="autoFillShippingDetails()" #statesBilling class="splSales" name="billingDetails.stateCode" [options]="statesSource$ | async" [(ngModel)]="invFormData.account.billingDetails.stateCode"></ng-select>
                  </div>
                  <div class="mrT2">
                    <label>GSTIN</label>
                    <input maxLength="15" type="text" name="billingDetails.gstNumber" class="form-control" [(ngModel)]="invFormData.account.billingDetails.gstNumber"
                      (keyup)="getStateCode('billingDetails', statesBilling); autoFillShippingDetails()" />
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-6">
              <div class="row">
                <div class="form-group" [ngClass]="{'col-xs-8':invFormData.country.countryName === 'India', 'col-xs-12': invFormData.country.countryName !== 'India' }">
                  <label style="width:340px;">
                    <input type="checkbox" (change)="autoFillShippingDetails()" name="autoFillShipping" [(ngModel)]="autoFillShipping"> Shipping Address Same as Billing Address</label>
                  <textarea [readonly]="autoFillShipping" name="shippingDetails.address" class="form-control" [(ngModel)]="invFormData.account.shippingDetails.address[0]"
                    rows="5"></textarea>
                </div>
                <div class="form-group col-xs-4" *ngIf="invFormData.country.countryName === 'India'">
                  <div>
                    <label>State</label>
                    <ng-select [disabled]="autoFillShipping" #statesShipping class="splSales" name="shippingDetails.stateCode" [options]="statesSource$ | async" [(ngModel)]="invFormData.account.shippingDetails.stateCode"></ng-select>
                  </div>
                  <div class="mrT2">
                    <label>GSTIN</label>
                    <input [readonly]="autoFillShipping" maxLength="15" type="text" name="shippingDetails.gstNumber" class="form-control" [(ngModel)]="invFormData.account.shippingDetails.gstNumber"
                      (keyup)="getStateCode('shippingDetails', statesShipping)" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end row -->
      </div>
    </div>
    <!-- end mailing address collapse pane -->

    <div class="collapse-pane clearfix">
      <div class="collapse-pane-heading" (click)="isOthrDtlCollapsed = !isOthrDtlCollapsed">
        <div class="ico-box-wrap">
          <div class="ico-box">
            <span [ngClass]="isOthrDtlCollapsed ? 'icon-add' : 'icon-minus'" aria-hidden="true"></span>
          </div>
        </div>
        <div class="ico-head">Other Details</div>
      </div>
      <div [collapse]="isOthrDtlCollapsed" class="clearfix pdL3 pdR3 col-xs-11 mr0">
        <div class="row">
          <div class="form-group col-xs-2">
            <label>Ship Date</label>
            <input type="text" [placeholder]="giddhDateFormat" bsDatepicker name="shippingDate" [(ngModel)]="invFormData.other.shippingDate"
              class="form-control" value="{{ invFormData.other.shippingDate | date: giddhDateFormatUI }}" />
          </div>
          <div class="form-group col-xs-2">
            <label>Ship Via</label>
            <input type="text" name="shippedVia" [(ngModel)]="invFormData.other.shippedVia" class="form-control" />
          </div>
          <div class="form-group col-xs-2">
            <label>Tracking No.</label>
            <input type="text" name="trackingNumber" [(ngModel)]="invFormData.other.trackingNumber" class="form-control" />
          </div>
          <div class="form-group col-xs-2">
            <label>Field 1</label>
            <input type="text" name="customField1" [(ngModel)]="invFormData.other.customField1" class="form-control" />
          </div>
          <div class="form-group col-xs-2">
            <label>Field 2</label>
            <input type="text" name="customField2" [(ngModel)]="invFormData.other.customField2" class="form-control" />
          </div>
          <div class="form-group col-xs-2">
            <label>Field 3</label>
            <input type="text" name="customField3" [(ngModel)]="invFormData.other.customField3" class="form-control" />
          </div>
        </div>
      </div>
    </div>
    <!-- end other details collapse pane -->

  </section>

  <section class="clearfix pd1 pdB2 mrB2 whiteBg">
    <table class="table">
      <thead>
        <tr>
          <th *ngFor="let item of theadArr;" [hidden]="!item.display" attr.data-field="{{item.label}}">{{item.label}}</th>
          <th class="nested-table-wrap">
            <table width="100%" class="nested-table" cellspacing="0" cellspadding="0">
              <thead>
                <tr>
                  <th width="25%" *ngFor="let item of theadArrOpt;" attr.data-field="{{item.label}}">{{item.label}}</th>
                </tr>
              </thead>
            </table>
          </th>
          <th *ngFor="let item of theadArrReadOnly;" attr.data-field="{{item.label}}" [hidden]="!item.display">{{item.label}}</th>
        </tr>
      </thead>
      <tbody *ngFor="let entry of invFormData.entries; let entryIdx = index; let first = first; let last = last">
        <tr *ngFor="let transaction of entry.transactions;">
          <td>{{ entryIdx+1 }}</td>
          <td>
            <input type="text" [placeholder]="giddhDateFormat" bsDatepicker name="transaction.date_{{entryIdx}}" class="form-control text-right"
              [(ngModel)]="transaction.date" value="{{ transaction.date | date: giddhDateFormatUI }}" />
          </td>
          <td>
            <div class="ng-select-wrap">
              <sh-select
                style="width: 250px;"
                [options]="salesAccounts$ | async"
                [(ngModel)]="transaction.fakeAccForSelect2"
                name="transaction.fakeAccForSelect2_{{entryIdx}}"
                (selected)="onSelectSalesAccount($event,transaction,entryIdx)"
                [placeholder]="'Select A/c'"
                [notFoundLink]="true"
                (noResultsClicked)="onNoResultsClicked(entryIdx)"
                [multiple]="false"
                [ItemHeight]="67"
                [useInBuiltFilterForFlattenAc]="true"
                >
                <ng-template #optionTemplate let-option="option">
                  <a href="javascript:void(0)" class="list-item" style="border-bottom: 1px solid #ccc;">
                    <div class="item">{{ option.label }}</div>
                    <div class="item_unq">{{ option.additional?.uniqueName }}</div>
                  </a>
                </ng-template>
              </sh-select>
            </div>
            <input type="text" placeholder="Description" name="transaction.description_{{entryIdx}}" class="form-control mrT1" [(ngModel)]="transaction.description"
            />
          </td>
          <td>
            <div class="">
              <input type="text" [hidden]="transaction.hsnOrSac !== 'hsn'" readonly maxLength="10" placeholder="HSN/SAC" name="transaction.hsnNumber_{{entryIdx}}"
                class="form-control text-right" [(ngModel)]="transaction.hsnNumber" />
              <input type="text" [hidden]="transaction.hsnOrSac !== 'sac'" readonly maxLength="10" placeholder="HSN/SAC" name="transaction.sacNumber_{{entryIdx}}"
                class="form-control text-right" [(ngModel)]="transaction.sacNumber" />
            </div>
          </td>

          <!-- show/hide fields -->
          <td class="nested-table-wrap">
            <table width="100%" cellspacing="0" cellspadding="0">
              <tbody>
                <tr>
                  <td *ngIf="transaction.isStockTxn">
                    <table class="nested-table" width="100%" cellspacing="0" cellspadding="0">
                      <tbody>
                        <tr>
                          <td width="25%">
                            <input type="number" (keyup)="txnChangeOccurred()" (ngModelChange)="transaction.setAmount(entry)" placeholder="Quantity"
                              name="transaction.quantity_{{entryIdx}}" class="form-control text-right" [(ngModel)]="transaction.quantity"
                            />
                          </td>
                          <td width="25%">
                            <select class="form-control" name="transaction.stockUnit_{{entryIdx}}" [(ngModel)]="transaction.stockUnit">
                              <option *ngFor="let stock of transaction.stockList" [ngValue]="stock.id">{{stock.text}}</option>
                            </select>
                          </td>
                          <td width="25%">
                            <input type="number" (ngModelChange)="transaction.setAmount(entry)" (keyup)="txnChangeOccurred()" placeholder="Rate" name="transaction.rate_{{entryIdx}}"
                              class="form-control text-right" [(ngModel)]="transaction.rate" />
                          </td>
                          <td width="25%">
                            <input type="number" disabled="true" name="transaction.amount_{{entryIdx}}" class="form-control text-right" [(ngModel)]="transaction.amount"
                            />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td *ngIf="!transaction.isStockTxn">
                    <table class="nested-table" width="100%" cellspacing="0" cellspadding="0">
                      <tbody>
                        <tr>
                          <td width="25%">
                            <input type="text" disabled="true" class="form-control text-right" />
                          </td>
                          <td width="25%">
                            <input type="text" disabled="true" class="form-control text-right" />
                          </td>
                          <td width="25%">
                            <input type="text" disabled="true" class="form-control text-right" />
                          </td>
                          <td width="25%">
                            <input type="number" (ngModelChange)="transaction.setAmount(entry)" (keyup)="txnChangeOccurred()" placeholder="Amount" name="transaction.amount_{{entryIdx}}"
                              class="form-control text-right" [(ngModel)]="transaction.amount" />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
          <td>
            <discount-list (selectedDiscountItems)="selectedDiscountEvent($event, transaction, entry)"></discount-list>
          </td>
          <td>
            <input type="number" name="transaction.taxableValue_{{entryIdx}}" class="form-control text-right" readonly [(ngModel)]="transaction.taxableValue" />
          </td>
          <td class="tax-list-dd-wrap dropdown-container">
            <sales-tax-list
              class="salesTax"
              [showTaxPopup]="false"
              [taxes]="companyTaxesList$ | async"
              [applicableTaxes]="transaction.applicableTaxes"
              [taxListAutoRender]="transaction.taxRenderData"
              (selectedTaxEvent)="selectedTaxEvent($event, entry)"
              (taxAmountSumEvent)="taxAmountEvent($event, transaction, entry)">
            </sales-tax-list>
          </td>
          <td>
            <input type="number" name="transaction.total_{{entryIdx}}" class="form-control text-right" readonly [(ngModel)]="transaction.total"
            />
          </td>
          <td class="action-panel-td text-center">
            <span class="cp" *ngIf="last" (click)="addBlankRow(transaction)">
              <i class="icon-add" aria-hidden="true"></i>
            </span>
            <span class="cp" *ngIf="!last" (click)="removeTransaction(entryIdx)">
              <i class="icon-cross" aria-hidden="true"></i>
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- sub total and total calc -->
    <table class="table">
      <tbody>
        <tr>
          <td width="50%">
            <div class="col-xs-8 pdT1">
              <label class="mrB1">Message</label>
              <textarea style="height:140px" class="form-control" name="message2" [(ngModel)]="invFormData.other.message2"></textarea>
            </div>
          </td>
          <td width="50%">
            <section class="tableSec">
              <div class="tableRow">
                <div class="tableCell">Total Amount</div>
                <div class="tableCell figureCell">{{invFormData.subTotal | number:'1.2-2'}}</div>
              </div>
              <div class="tableRow">
                <div class="tableCell">Discount</div>
                <div class="tableCell figureCell">-{{invFormData.totalDiscount | number:'1.2-2'}}</div>
              </div>
              <div class="tableRow">
                <div class="tableCell">Taxable Value</div>
                <div class="tableCell figureCell">{{invFormData.totalTaxableValue | number:'1.2-2'}}</div>
              </div>
              <div class="tableRow">
                <div class="tableCell">Tax</div>
                <div class="tableCell figureCell">{{invFormData.totalTax | number:'1.2-2'}}</div>
              </div>
              <div class="tableRow">
                <div class="tableCell">
                  <strong>Total</strong>
                </div>
                <div class="tableCell figureCell">
                  <strong>{{invFormData.grandTotal | number:'1.2-2'}}</strong>
                </div>
              </div>
              <div class="tableRow">
                <div class="tableCell">Deposit</div>
                <div class="tableCell figureCell">
                  <input type="number" (blur)="txnChangeOccurred()" placeholder="Amount" name="dueAmount" class="form-control" [(ngModel)]="dueAmount"
                  />
                </div>
              </div>
              <div class="tableRow">
                <div class="tableCell">
                  <strong>Balance Due</strong>
                </div>
                <div class="tableCell figureCell">
                  <strong>{{invFormData.balanceDue | number:'1.2-2'}}</strong>
                </div>
              </div>
            </section>
          </td>
        </tr>
      </tbody>
    </table>
    <!-- end -->
  </section>

  <section class="row">
    <section id="actionPane" class="text-center">
      <div class="col-xs-12">
        <div class="pull-right pr">
          <button type="button" (click)="resetInvoiceForm(invoiceForm)" class="btn btn-danger">Clear</button>
          <button type="button" (click)="triggerSubmitInvoiceForm(invoiceForm)" class="btn btn-default">Generate Invoice &amp; Update A/c</button>
          <button type="submit" class="btn btn-success">Generate Invoice</button>
        </div>
      </div>
    </section>
  </section>
</form>

<!-- open account aside -->
<div class="aside-overlay" *ngIf="accountAsideMenuState === 'in' || asideMenuStateForProductService === 'in'"></div>
<aside-menu-account [class]="accountAsideMenuState" [@slideInOut]="accountAsideMenuState" (closeAsideEvent)="toggleAccountAsidePane($event)"></aside-menu-account>

<!-- open product service aside -->
<aside-menu-product-service [class]="asideMenuStateForProductService" [@slideInOut]="asideMenuStateForProductService" (closeAsideEvent)="onNoResultsClicked()" (animatePAside)="getActionFromAside($event)"></aside-menu-product-service>


<!-- create Group modal -->
<section *ngIf="showCreateGroupModal">
  <div bsModal #createGroupModal="bs-modal" class="modal fade" role="dialog" [config]="modalConfig">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <sales-add-group-modal (actionFired)="closeCreateGroupModal($event)"></sales-add-group-modal>
      </div>
    </div>
  </div>
</section>

<!-- create Ac modal -->
<section *ngIf="showCreateAcModal">
  <div bsModal #createAcModal="bs-modal" class="modal fade" role="dialog" [config]="modalConfig">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <create-account-modal [gType]="createAcCategory" (actionFired)="closeCreateAcModal()"></create-account-modal>
      </div>
    </div>
  </div>
</section>
