<section id="manufacture" class="container-fluid">
  <!--<div>
    {{ manufacturingDetails | json }}
  </div>-->
  <div class="row">
    <!-- page Title -->
    <div class="col-xs-12 bdrB">
      <div class="row mrL3 mrR3 pd1 pdL0">
        <h1 class="section_title d-inline-block"><strong>Manufacture of Product</strong> &nbsp; &nbsp;<label *ngIf="isUpdateCase">No. {{manufacturingDetails.voucherNumber}}</label></h1>
        <button class="btn btn-primary pull-right" (click)="goBackToListPage();">Back</button>
      </div>
    </div>

    <!-- form -->
    <div class="col-xs-12">
      <div class="row mrL3 mrR3 pd1 pdL0 pdB0">
        <form class="" name="manufaturingForm" #manufaturingForm="ngForm">
          <div class="form-group col-xs-2">
            <div class="row">
              <label class="small">Product Name</label>
              <select2 [disabled]="isUpdateCase" [(ngModel)]="manufacturingDetails.stockUniqueName" name="stockUniqueName" [data]="stockListDropDown$ | async"
                [options]="options" (valueChanged)="getStocksWithRate($event)">
              </select2>
            </div>
          </div>
          <!--<div class="form-group col-xs-4">
        <label>Quantity</label>
        <input type="text" class="form-control" [(ngModel)]="manufacturingDetails.quantity" name="manufaturingQuanity" />
      </div>-->
          <div class="form-group col-xs-2">
            <label class="small">Quantity</label>
            <input type="text" class="form-control" (ngModelChange)="onQuantityChange($event)" [(ngModel)]="manufacturingDetails.quantity" name="multipleOf" />
            <small class="pull-right">Multiple of {{manufacturingDetails.multipleOf | json}}</small>
          </div>
          <div class="form-group col-xs-2" (clickOutside)="showFromDatePicker=false;">
            <label>Date</label>
            <div class="input-group">
              <input type="text" name="from" [ngModel]="moment(manufacturingDetails.date).format('DD-MM-YYYY')" (focus)="showFromDatePicker = true;"
                class="form-control" required/>
              <span class="input-group-btn">
                <button type="button" class="btn btn-default" (click)="showFromDatePicker = !showFromDatePicker">
                <i class="glyphicon glyphicon-calendar"></i>
                </button>
            </span>
            </div>
            <div *ngIf="showFromDatePicker" style="position: absolute; z-index:10; min-height:290px;">
              <datepicker name="fromDate" [(ngModel)]="manufacturingDetails.date" (selectionDone)="showFromDatePicker=!showFromDatePicker"
                [showWeeks]="true"></datepicker>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- form end -->

    <!--  -->
    <div class="container-fluid col-xs-offset-1 clearfix pdT2 bdrT" *ngIf="manufacturingDetails.stockUniqueName">

      <!-- right column / add more resources -->
      <div class="col-xs-6 source bdrR">
        <p class="width100 mrB2">Source(Consumption)</p>
        <section class="linkstock">
          <table class="col-xs-12 linkStockTbl" *ngIf="manufacturingDetails">
            <thead>
              <tr>
                <th colspan="9">Product Name</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Rate</th>
                <th>Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody *ngIf="manufacturingDetails">
              <tr *ngFor="let stock of manufacturingDetails.linkedStocks; let i = index;">
                <td colspan="9"><span class="hr"></span>{{ stock.stockUniqueName }}</td>
                <td>{{ stock.quantity | number:'1.0-4'}}</td>
                <td *ngIf="!isUpdateCase">{{ stock.stockUnitCode }}</td>
                <td *ngIf="isUpdateCase">{{ stock.manufacturingUnit }}</td>
                <!--<td><input type="text" [(ngModel)]="stock.quantity" name="quantity_{{i}}"></td>-->
                <td>{{ stock.rate | number:'1.0-4'}}</td>
                <!--<td><input type="text" [(ngModel)]="stock.rate" name="rate_{{i}}"></td>-->
                <td>{{ stock.amount | number:'1.0-4'}}</td>
                <td class="action"><i class="fa fa-times" (click)="removeConsumptionItem(i)" aria-hidden="true"></i>
                </td>
              </tr>

              <tr *ngIf="toggleAddLinkedStocks" class="new-row">
                <td colspan="9" class="custom-select pos-rel">
                  <span class="hr"></span>
                  <select class="form-control" [(ngModel)]="linkedStocks.stockUniqueName" (change)="getStockUnit(linkedStocks.stockUniqueName)" required #linkedStockList="ngModel">
                    <option value="select" [selected]="true">select</option>
                    <option [ngValue]="stock.id" *ngFor="let stock of stockListDropDown$ | async" >{{ stock.text }}</option>
                  </select>
                  <span class="select_drop" style="right: 16px;top: 18px;"><i class="fa fa-caret-down"></i></span>

                </td>
                <td>
                  <input type="number" required class="form-control" [(ngModel)]="linkedStocks.quantity" #linkedStockQuantity="ngModel">
                </td>
                <td>{{linkedStocks.manufacturingUnit}}</td>
                <!--<td *ngIf="!isUpdateCase">{{linkedStocks.stockUnitCode }}</td>
                <td *ngIf="isUpdateCase">{{linkedStocks.manufacturingUnit || linkedStocks.stockUnitCode}}</td>-->
          
                <td><input type="number" required class="form-control" [(ngModel)]="linkedStocks.rate" #linkedStockRate="ngModel"></td>
                <td> {{ getCalculatredAmount(linkedStockQuantity, linkedStockRate) }} </td>
                <!--<td><input type="number" required class="form-control" [(ngModel)]="linkedStocks.amount" #linkedStockAmount="ngModel"></td>-->

                <td class="action">
                  <button [disabled]="linkedStockQuantity.invalid || linkedStockRate.invalid || linkedStockList.invalid" (click)="addConsumption(linkedStocks)"
                    class="ico-btn pd0"><i class="fa fa-plus text-danger" aria-hidden="true"></i></button>
                </td>
              </tr>

              <tr>
                <td colspan="5"><a href="javascript:void(0);" (click)="toggleAddLinkedStocks = !toggleAddLinkedStocks">Add New</a>
                </td>
              </tr>
            </tbody>
            <tfoot class="bdrT pdT2 pdB2 bdrB">
              <tr>
                <td colspan="9">Total:</td>
                <td class="text-right"> {{ getTotal('linkedStocks', 'quantity') | number:'1.0-4' }} </td>
                <td></td>
                <td></td>
                <td class="text-right"> {{ getTotal('linkedStocks', 'amount') | currency:'INR':true:'1.0-4' }} </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </section>
      </div>
      <!-- end right column -->

      <!-- left column / total cost table -->
      <div class="col-xs-5">
        <div class="form_title">
          <p>Total Cost</p>
        </div>
        <form class="form-theme clearfix" name="expenseForm">
          <div class="mrB2 clearfix">
            <p class="col-xs-9 pd0">Total Consumption Cost:</p>
            <p class="col-xs-3 text-right">{{ getTotal('linkedStocks', 'amount') | currency:'INR':true:'1.0-4' }}</p>
          </div>
          <table class="width100">
            <thead class="tcaption">
              <tr>
                <td tooltip="Add A/C where expense entries will be done." placement="top" colspan="5">Add Expense <i class="fa fa-plus cursor-pointer" (click)="toggleAddExpenses = !toggleAddExpenses" aria-hidden="true"></i>
                </td>
              </tr>
            </thead>
            <tbody *ngIf="manufacturingDetails">
              <tr *ngFor="let expense of manufacturingDetails.otherExpenses; let i = index;">
                <td colspan="1">
                  <select class="form-control">
                    <option (value)="expense.baseAccount.uniqueName">{{ expense.baseAccount.uniqueName }}</option>
                </select>
                  <span class="select_drop"><i class="fa fa-caret-down"></i></span>
                  <label>to</label>
                  <select class="form-control">
                    <option (value)="expense.transactions[0].account.uniqueName">{{ expense.transactions[0].account.uniqueName }}</option>
                </select>
                  <span class="select_drop"><i class="fa fa-caret-down"></i></span>
                </td>
                <td class="pull-right">{{ expense.transactions[0].amount }}</td>
                <td><i class="fa fa-times" aria-hidden="true" (click)="removeExpenseItem(i)"></i>
                </td>
              </tr>
              <tr *ngIf="toggleAddExpenses">
                <td colspan="1">
                  <select class="form-control" required #baseAccountUniqueName="ngModel" [(ngModel)]="otherExpenses.baseAccountUniqueName"
                    name="baseAccountUniqueName">
                      <option value="">Expense A/C</option>
                      <option [ngValue]="account.id" *ngFor="let account of expenseGroupAccounts">{{ account.text }}</option>
                  </select>
                  <span class="select_drop"><i class="fa fa-caret-down"></i></span>
                  <label>to</label>
                  <select class="form-control" required #transactionAccountUniqueName="ngModel" [(ngModel)]="otherExpenses.transactionAccountUniqueName"
                    name="transactionAccountUniqueName">
                      <option value="">Liabilities/Assets A/C</option>
                      <option [ngValue]="account.id" *ngFor="let account of liabilityGroupAccounts">{{ account.text }}</option>                    
                  </select>
                  <span class="select_drop"><i class="fa fa-caret-down"></i></span>
                </td>
                <td class="pull-right">
                  <input type="number" required placeholder="Amount" [(ngModel)]="otherExpenses.transactionAmount" name="transactionAmount" class="form-control"
                    #transactionAmount="ngModel"></td>
                <td class="action">
                  <button [disabled]="transactionAmount.invalid || transactionAccountUniqueName.invalid || baseAccountUniqueName.invalid" (click)="addExpense(otherExpenses)"
                    style="margin-top: 12px;" class="ico-btn pd0"><i class="fa fa-plus text-danger" aria-hidden="true"></i></button>
                </td>
              </tr>
              <!--<tr>
              <td colspan="1">
                <select class="form-control">
                                    <option value="directexpense">Direct Expense</option>
                                </select>
                <span class="select_drop"><i class="fa fa-caret-down"></i></span>
                <label>to</label>
                <select class="form-control">
                                    <option value="Liability">Liability</option>
                                </select>
                <span class="select_drop"><i class="fa fa-caret-down"></i></span>
              </td>
              <td class="pull-right">2000.00</td>
              <td><i class="fa fa-times" aria-hidden="true"></i>
              </td>
            </tr>-->
            </tbody>
          </table>
          <div class="pdB2 bdrT clearfix pdT2 mrT1">
            <p class="col-xs-9 pd0"><strong>Total Manufacturing Cost:</strong></p>
            <p class="col-xs-3 text-right"><strong>{{ getTotal('otherExpenses', 'amount') | currency:'INR':true:'1.0-4' }}</strong></p>
          </div>
          <div class="mrB1 pdB2 clearfix">
            <p class="col-xs-9 pd0"><strong>Grand Total:</strong></p>
            <p class="col-xs-3 text-right"><strong>{{ (getTotal('otherExpenses', 'amount') + getTotal('linkedStocks', 'amount')) | currency:'INR':true:'1.0-4' }}</strong></p>
          </div>
          <div class="mrB1 pdB2 clearfix">
            <p class="col-xs-9 pd0"><strong>Cost per {{manufacturingDetails.stockUniqueName}}:</strong></p>
            <p class="col-xs-3 text-right"><strong>{{ getCosePerProduct() | currency:'INR':true:'1.0-4'}}</strong></p>
          </div>
          <div class="pull-right" *ngIf="!isUpdateCase">
            <button type="submit" class="btn btn-md btn-success mrR1" (click)="createEntry();">Save</button>
            <button type="button" class="btn btn-md btn-primary" (click)="goBackToListPage()">Cancel</button>
          </div>
          <div class="pull-right" *ngIf="isUpdateCase">
            <button type="submit" class="btn btn-md btn-success mrR1" (click)="updateEntry()">Update</button>
            <button type="button" class="btn btn-md btn-danger" (click)="deleteEntry()">Delete</button>
          </div>
        </form>
      </div>
      <!-- end left column -->

    </div>
  </div>
</section>

<!--delete manufacturing confirmation modal -->
<div bsModal #manufacturingConfirmationModal="bs-modal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-md">
    <!-- modal-liq90 class is removed for now-->
    <div class="modal-content">
      <delete-manufacturing-confirmation-modal (closeModelEvent)="closeConfirmationPopup($event)"></delete-manufacturing-confirmation-modal>
    </div>
  </div>
</div>
